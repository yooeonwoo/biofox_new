# BIOFOX KOL 관리자 페이지 개발 종합 보고서

## 📋 문서 개요
이 보고서는 BIOFOX KOL 시스템의 새로운 관리자 페이지 개발을 위해 기존 시스템을 분석한 결과를 종합적으로 정리합니다.

---

## 🔐 인증 및 권한 시스템

### 1. 인증 시스템 구조
- **인증 제공자**: Clerk Authentication
- **인증 방식**: JWT 토큰 기반 세션 관리
- **미들웨어**: `middleware.ts`에서 라우트별 인증 처리

### 2. 현재 역할 체계

#### 사용자 역할 (User Roles)
```typescript
// 기본 역할 체계
- "admin": 본사 관리자
- "kol": KOL (Key Opinion Leader)
```

#### 권한별 라우트 매핑
```javascript
const roleLandingPages = {
  "admin": "/admin-dashboard/main",
  "kol": "/kol-new"
};
```

### 3. 인증 흐름

#### 미들웨어 인증 처리 순서
1. **공개 경로 체크** (`/`, `/signin`, `/signup`, `/api/webhooks`)
2. **무시 경로 체크** (`/kol-new`, `/admin-dashboard`, `/api/*`)
3. **사용자 인증 확인** (Clerk 세션)
4. **역할별 리다이렉트** 처리
5. **권한 기반 접근 제어**

#### Clerk 메타데이터 구조
```typescript
interface ClerkUser {
  id: string;
  email_addresses: Array<{ email_address: string }>;
  first_name?: string;
  last_name?: string;
  public_metadata: {
    role: "admin" | "kol";
  };
  private_metadata?: Record<string, any>;
}
```

---

## 🗄️ 데이터베이스 구조

### 1. 핵심 테이블 구조

#### Users 테이블
```sql
CREATE TABLE users (
  id SERIAL PRIMARY KEY,
  clerk_id VARCHAR(255) NOT NULL UNIQUE,
  email VARCHAR(255) NOT NULL UNIQUE,
  name VARCHAR(255),
  role VARCHAR(50) NOT NULL DEFAULT 'kol',
  created_at TIMESTAMP DEFAULT NOW(),
  updated_at TIMESTAMP DEFAULT NOW()
);
```

#### KOLs 테이블
```sql
CREATE TABLE kols (
  id SERIAL PRIMARY KEY,
  user_id INTEGER REFERENCES users(id),
  name VARCHAR(255) NOT NULL,
  shop_name VARCHAR(255) NOT NULL,
  region VARCHAR(100),
  smart_place_link VARCHAR(500),
  status VARCHAR(50) DEFAULT 'active',
  created_at TIMESTAMP DEFAULT NOW(),
  updated_at TIMESTAMP DEFAULT NOW()
);
```

#### Shops 테이블 (전문점)
```sql
CREATE TABLE shops (
  id SERIAL PRIMARY KEY,
  owner_name VARCHAR(255) NOT NULL,
  shop_name VARCHAR(255) NOT NULL,
  kol_id INTEGER REFERENCES kols(id),
  region VARCHAR(100),
  smart_place_link VARCHAR(500),
  is_owner_kol BOOLEAN DEFAULT FALSE,
  contract_date TIMESTAMP,
  email VARCHAR(255),
  owner_kol_id INTEGER REFERENCES kols(id),
  is_self_shop BOOLEAN DEFAULT FALSE,
  status VARCHAR(50) DEFAULT 'active',
  created_at TIMESTAMP DEFAULT NOW(),
  updated_at TIMESTAMP DEFAULT NOW()
);
```

### 2. 메트릭 관련 테이블

#### KOL 대시보드 메트릭
```sql
CREATE TABLE kol_dashboard_metrics (
  id SERIAL PRIMARY KEY,
  kol_id INTEGER REFERENCES kols(id),
  year_month VARCHAR(7) NOT NULL, -- YYYY-MM 형식
  monthly_sales INTEGER DEFAULT 0,
  monthly_commission INTEGER DEFAULT 0,
  active_shops_count INTEGER DEFAULT 0,
  total_shops_count INTEGER DEFAULT 0,
  created_at TIMESTAMP DEFAULT NOW(),
  updated_at TIMESTAMP DEFAULT NOW()
);
```

#### 전문점 매출 메트릭
```sql
CREATE TABLE shop_sales_metrics (
  id SERIAL PRIMARY KEY,
  shop_id INTEGER REFERENCES shops(id),
  year_month VARCHAR(7) NOT NULL,
  total_sales INTEGER DEFAULT 0,
  product_sales INTEGER DEFAULT 0,
  device_sales INTEGER DEFAULT 0,
  commission INTEGER DEFAULT 0,
  created_at TIMESTAMP DEFAULT NOW(),
  updated_at TIMESTAMP DEFAULT NOW()
);
```

### 3. 임상 관련 테이블

#### 임상 케이스 및 사진 관리
- `clinical_customers`: 임상 고객 정보
- `clinical_cases`: 임상 케이스 정보  
- `clinical_photos`: 임상 사진 저장
- `clinical_round_info`: 회차별 시술 정보
- `clinical_consent_files`: 동의서 파일

---

## 🛠️ API 구조

### 1. 관리자 API 엔드포인트

#### 사용자 관리 API (`/api/admin/users`)
```typescript
// GET: 모든 사용자 조회
interface GetUsersResponse {
  users: Array<{
    id: number;
    clerkId: string;
    email: string;
    role: string;
    name: string;
    kolId?: number;
    kolName?: string;
    shopName?: string;
    kolStatus?: string;
    region?: string;
  }>;
}

// POST: 신규 사용자 초대
interface CreateUserRequest {
  email: string;
  role: "admin" | "kol";
  name?: string;
  shopName?: string;
}

// PATCH: 사용자 역할 변경
interface UpdateUserRoleRequest {
  userId: number;
  role: "admin" | "kol";
}

// DELETE: 사용자 삭제
```

#### KOL 메트릭 관리 API (`/api/admin/kol-metrics`)
```typescript
// POST: 메트릭 업데이트/검증
interface KolMetricsRequest {
  action: "update_metrics" | "verify_metrics";
  yearMonth: string; // YYYY-MM 형식
}

// GET: 메트릭 조회
interface GetMetricsResponse {
  metrics: Array<{
    kol_id: number;
    year_month: string;
    total_shops_count: number;
    active_shops_count: number;
    monthly_sales: number;
    monthly_commission: number;
    kols: {
      name: string;
      shop_name: string;
    };
  }>;
}
```

### 2. KOL 전용 API 엔드포인트

#### 대시보드 API (`/api/kol-new/*`)
- `/dashboard`: KOL 대시보드 데이터
- `/monthly-sales`: 월간 매출 데이터
- `/shops`: 관리 전문점 정보
- `/activities`: 활동 내역
- `/notifications`: 알림 관리

#### 임상 사진 API (`/api/kol-new/clinical-photos/*`)
- `/upload`: 사진 업로드
- `/cases/[caseId]/photos`: 케이스별 사진 관리
- `/consent/[caseId]`: 동의서 관리

---

## 🎨 현재 UI/UX 구조

### 1. 관리자 대시보드 레이아웃

#### 사이드바 메뉴 구조
```typescript
const menuItems = [
  { name: '대시보드', href: '/admin-dashboard/main', icon: LayoutDashboard },
  { name: '사용자 관리', href: '/admin-dashboard/user-management', icon: UserPlus },
  { name: 'KOL 및 전문점 관리', href: '/admin-dashboard/entities', icon: Users },
  { name: 'KOL 데이터 입력', href: '/admin-dashboard/kol-data-entry', icon: FileInput },
  { name: 'KOL 현황', href: '/admin-dashboard/kol-dashboard', icon: BarChart },
  { name: 'KOL 메트릭스 관리', href: '/admin-dashboard/kol-metrics-management', icon: Settings },
];
```

#### UI 라이브러리 스택
- **메인 프레임워크**: Next.js 15.2.3, React 19.1.0
- **UI 컴포넌트**: Radix UI 컴포넌트들
- **아이콘**: Lucide React, Tabler Icons
- **스타일링**: Tailwind CSS
- **애니메이션**: Framer Motion
- **차트**: Chart.js, Recharts

### 2. 권한별 접근 제어

#### 관리자 페이지 보호
```typescript
// 관리자 권한 체크 로직
const checkAdmin = () => {
  const userRole = user.publicMetadata?.role as string;
  if (userRole !== 'admin') {
    window.location.href = '/';
    return;
  }
  setIsAdmin(true);
};
```

---

## 🔧 기술 스택 및 의존성

### 1. 핵심 기술 스택

#### 프론트엔드
- **Framework**: Next.js 15.2.3 (App Router)
- **Language**: TypeScript 5.8.2
- **State Management**: React Query (TanStack Query)
- **Form Handling**: React Hook Form + Zod 검증

#### 백엔드
- **Database**: PostgreSQL (via Supabase)
- **ORM**: Drizzle ORM
- **Authentication**: Clerk
- **API**: Next.js API Routes

#### 인프라
- **Database Hosting**: Supabase
- **File Storage**: Supabase Storage
- **Authentication Service**: Clerk

### 2. 주요 의존성 라이브러리

```json
{
  "authentication": {
    "@clerk/nextjs": "^6.20.1",
    "@clerk/backend": "^1.34.0",
    "@clerk/clerk-sdk-node": "^5.1.6"
  },
  "database": {
    "@supabase/supabase-js": "^2.49.8",
    "drizzle-orm": "^0.41.0",
    "drizzle-kit": "^0.30.5"
  },
  "ui_components": {
    "@radix-ui/react-*": "다양한 버전",
    "lucide-react": "^0.483.0",
    "framer-motion": "^12.5.0"
  },
  "data_visualization": {
    "chart.js": "^4.4.8",
    "react-chartjs-2": "^5.3.0",
    "recharts": "^2.15.1"
  }
}
```

---

## 🚨 주의사항 및 고려사항

### 1. 보안 관련

#### 환경 변수 관리
```env
# 필수 환경 변수
NEXT_PUBLIC_CLERK_PUBLISHABLE_KEY=
CLERK_SECRET_KEY=
NEXT_PUBLIC_SUPABASE_URL=
NEXT_PUBLIC_SUPABASE_ANON_KEY=
SUPABASE_SERVICE_ROLE_KEY=
DATABASE_URL=
```

#### 권한 관리 주의사항
- 클라이언트 사이드에서 역할 검증은 UI 표시용
- 실제 권한 검증은 서버 사이드에서 수행 필요
- API 엔드포인트마다 권한 체크 로직 구현 필요

### 2. 데이터 무결성

#### 사용자 생성 플로우
1. **Pending 상태로 DB 저장**: `clerk_id: pending_${timestamp}`
2. **실제 가입 시 Clerk ID 업데이트**: Webhook 또는 수동 업데이트
3. **KOL 역할시 추가 데이터 생성**: kols 테이블에 연관 데이터 생성

#### 메트릭 데이터 관리
- 월별 메트릭 데이터는 배치 처리로 업데이트
- 실시간 계산보다는 사전 계산된 데이터 사용
- 데이터 정확성 검증 기능 필요

### 3. 성능 최적화

#### 데이터베이스 쿼리
- 관계형 쿼리 최적화 (JOIN 사용 주의)
- 인덱스 설정 확인 필요
- 페이지네이션 구현 필요

#### 프론트엔드 최적화
- React Query 캐싱 전략
- 컴포넌트 Lazy Loading
- 이미지 최적화 (Next.js Image 컴포넌트)

---

## 📊 현재 시스템 한계 및 개선점

### 1. 현재 한계사항

#### 사용자 관리
- 역할 체계가 단순함 (admin/kol만 존재)
- 세분화된 권한 관리 부족
- 사용자 초대 시스템이 완전 자동화되지 않음

#### 데이터 관리
- 메트릭 데이터 실시간 업데이트 부족
- 데이터 백업 및 복구 시스템 미흡
- 로그 및 감사 추적 기능 부족

#### UI/UX
- 모바일 최적화 부분적
- 다국어 지원 없음
- 접근성(Accessibility) 고려 부족

### 2. 권장 개선사항

#### 권한 시스템 강화
```typescript
// 제안: 세분화된 권한 시스템
interface Permission {
  resource: 'users' | 'kols' | 'shops' | 'metrics' | 'reports';
  action: 'create' | 'read' | 'update' | 'delete';
  scope: 'all' | 'own' | 'team';
}

interface Role {
  name: string;
  permissions: Permission[];
}
```

#### 감사 로그 시스템
```sql
CREATE TABLE audit_logs (
  id SERIAL PRIMARY KEY,
  user_id INTEGER REFERENCES users(id),
  action VARCHAR(100) NOT NULL,
  resource_type VARCHAR(50) NOT NULL,
  resource_id INTEGER,
  old_values JSONB,
  new_values JSONB,
  timestamp TIMESTAMP DEFAULT NOW()
);
```

#### 알림 시스템 개선
- 실시간 알림 (WebSocket/SSE)
- 이메일 알림 통합
- 알림 설정 개인화

---

## 🎯 새 관리자 페이지 개발 가이드라인

### 1. 아키텍처 권장사항

#### 폴더 구조
```
app/
├── admin/                    # 새 관리자 영역
│   ├── layout.tsx           # 관리자 레이아웃
│   ├── dashboard/           # 메인 대시보드
│   ├── users/               # 사용자 관리
│   ├── kols/                # KOL 관리  
│   ├── shops/               # 전문점 관리
│   ├── metrics/             # 메트릭 관리
│   ├── settings/            # 시스템 설정
│   └── reports/             # 보고서
├── api/
│   └── admin/               # 관리자 API (기존 활용)
└── components/
    └── admin/               # 관리자 전용 컴포넌트
```

#### 컴포넌트 설계 원칙
- **재사용성**: 공통 컴포넌트 최대 활용
- **타입 안전성**: TypeScript 엄격 모드 사용
- **접근성**: ARIA 속성 및 키보드 탐색 지원
- **반응형**: 모바일 퍼스트 설계

### 2. 데이터 플로우

#### 상태 관리 전략
```typescript
// React Query를 활용한 서버 상태 관리
const useUsers = () => {
  return useQuery({
    queryKey: ['admin', 'users'],
    queryFn: fetchUsers,
    staleTime: 5 * 60 * 1000, // 5분
    cacheTime: 10 * 60 * 1000, // 10분
  });
};

// 낙관적 업데이트
const useUpdateUser = () => {
  const queryClient = useQueryClient();
  
  return useMutation({
    mutationFn: updateUser,
    onMutate: async (newUser) => {
      // 낙관적 업데이트 로직
    },
    onError: (err, newUser, context) => {
      // 에러 시 롤백
    },
    onSettled: () => {
      queryClient.invalidateQueries(['admin', 'users']);
    },
  });
};
```

### 3. 보안 체크리스트

#### API 보안
- [ ] 모든 관리자 API에 권한 체크 구현
- [ ] CSRF 토큰 검증
- [ ] Rate Limiting 구현
- [ ] 입력값 검증 및 살균(Sanitization)

#### 클라이언트 보안
- [ ] 민감한 정보 클라이언트 노출 방지  
- [ ] XSS 방지 (dangerouslySetInnerHTML 사용 금지)
- [ ] 사용자 입력 검증

### 4. 성능 최적화

#### 번들 크기 최적화
```typescript
// 코드 분할
const UserManagement = lazy(() => import('./UserManagement'));
const KolManagement = lazy(() => import('./KolManagement'));

// 트리 쉐이킹을 위한 명시적 import
import { Button } from '@/components/ui/button';
import { Dialog } from '@/components/ui/dialog';
```

#### 렌더링 최적화
```typescript
// React.memo 활용
const UserRow = memo(({ user, onUpdate, onDelete }) => {
  return (
    <tr>
      {/* 사용자 정보 표시 */}
    </tr>
  );
});

// useMemo로 비싼 계산 캐싱
const sortedUsers = useMemo(() => {
  return users.sort((a, b) => a.name.localeCompare(b.name));
}, [users]);
```

---

## 🚀 Admin-New 전환 전략

> 기존 기능 안정성을 유지하면서 신규 관리자 영역을 점진적으로 구축하기 위한 원칙입니다.

1. **독립 모듈 설계**  
   새 관리자 UI, API, DB 모두 _기존 코드와 별도 네임스페이스/테이블_ 로 생성합니다. (예: `admin_new_*` 테이블 prefix)
2. **새 역할 도입**  
   Clerk `public_metadata.role` 에 `admin-new` 값을 추가하여, **`admin-new` 역할을 가진 사용자만** `/admin-new` 경로에 접근하도록 합니다.
3. **라우팅 격리**  
   `middleware.ts` 에 `admin-new` 전용 보호 로직을 추가하고, 신규 진입점은 `/admin-new` 입니다.
4. **데이터 마이그레이션**  
   기능 검증이 끝난 후에만 기존 테이블 데이터를 `admin_new_*` 구조로 마이그레이션하고, 충분한 모니터링 기간 후 _레거시 테이블을 삭제_ 합니다.
5. **점진적 기능 이전**  
   UI → API → 배치/잡 순서로 모듈을 하나씩 교체하여 리스크를 최소화합니다.

> 이 전략을 통해 현재 운영 중인 관리자 기능에 영향을 주지 않으면서 새로운 시스템으로 안전하게 전환할 수 있습니다.

---

## 📝 결론 및 다음 단계

### 1. 현재 시스템 평가
- **장점**: 안정적인 인증 시스템, 체계적인 데이터베이스 구조, 현대적인 기술 스택
- **개선 필요**: 권한 관리 세분화, 실시간 데이터 처리, 사용자 경험 향상

### 2. 새 관리자 페이지 개발 우선순위

#### Phase 1: 핵심 기능
1. 사용자 관리 개선 (역할 세분화)
2. 대시보드 리뉴얼 (실시간 메트릭)
3. KOL/전문점 관리 통합

#### Phase 2: 고급 기능  
1. 보고서 생성 시스템
2. 감사 로그 및 모니터링
3. 알림 시스템 고도화

#### Phase 3: 최적화
1. 성능 최적화
2. 모바일 최적화
3. 접근성 개선

### 3. 개발 시 주의사항
- 기존 API 엔드포인트 최대한 재활용
- 점진적 마이그레이션 (기존 시스템과 병행 운영)
- 충분한 테스트 및 백업 계획 수립

---

*이 보고서는 BIOFOX KOL 시스템의 새로운 관리자 페이지 개발을 위한 종합 가이드입니다. 개발 진행 시 이 문서를 참조하여 일관성 있고 안전한 시스템을 구축하시기 바랍니다.*