========================
1. 데이터베이스 상세 설계서  
========================

⚠️ 전제 및 주의  
• 기존 `shop_sales_metrics`, `kol_total_monthly_sales` 등 레거시 테이블은 **절대 사용·참조하지 않는다** (삭제 예정).  
• 유지 테이블: `users`, `kols`, `shops`  
• 신규 테이블은 모두 `public` 스키마에 생성, 필요시 RLS 별도 설계.  
• 모든 정수형 통화 값은 원화(KRW) 기준 `INT`(₩) 로 저장.  
• 숫자 비율은 `%` → `NUMERIC(5,2)` 로 저장.  
• 트랜잭션 무결성 보장을 위해 모든 수동 수정(관리자 UI)도 DB 트리거 대신 **스토어드 프로시저** 호출로 일관 처리.

--------------------------------------------------
A. users (기존 유지)  
--------------------------------------------------
| 컬럼 | 타입 | 제약 | 설명 |
|------|------|------|------|
| id | SERIAL PK |  | 내부 PK |
| clerk_id | VARCHAR(255) UNIQUE | NOT NULL | Clerk UID |
| email | VARCHAR(255) UNIQUE | NOT NULL | |
| name | VARCHAR(255) |  | |
| role | VARCHAR(20) | NOT NULL DEFAULT ‘kol’ | ‘admin-new’ \| ‘kol’ \| ‘ol’ |
| status | VARCHAR(20) | NOT NULL DEFAULT ‘active’ | ‘active’ \| ‘suspended’ 등 |
| created_at / updated_at | TIMESTAMPTZ | DEFAULT now() | |

--------------------------------------------------
B. kols (기존 유지)  
--------------------------------------------------
| 컬럼 | 타입 | 제약 | 설명 |
|------|------|------|------|
| id | SERIAL PK |  | |
| user_id | INT FK → users.id | NOT NULL UNIQUE | 1:1 매핑 |
| name | VARCHAR(255) | NOT NULL | |
| region | VARCHAR(100) |  | |
| default_product_commission_pct | NUMERIC(5,2) | NULL | NULL 이면 시스템 기본값(‘kol’ 30 %) |
| created_at / updated_at | TIMESTAMPTZ | DEFAULT now() | |

--------------------------------------------------
C. shops (기존 유지)  
--------------------------------------------------
| 컬럼 | 타입 | 제약 | 설명 |
|------|------|------|------|
| id | SERIAL PK | | |
| kol_id | INT FK → kols.id | NOT NULL | 관리 KOL |
| owner_name | VARCHAR(255) | NOT NULL | |
| shop_name | VARCHAR(255) | NOT NULL | |
| region | VARCHAR(100) |  | |
| contract_date | DATE |  | |
| commission_override_pct | NUMERIC(5,2) | NULL | 제품 수당률 개별 오버라이드 |
| created_at / updated_at | TIMESTAMPTZ | DEFAULT now() | |

--------------------------------------------------
D. commission_rate_settings (제품 수당률 관리)  
--------------------------------------------------
| 컬럼 | 타입 | 제약 | 설명 |
|------|------|------|------|
| id | SERIAL PK | | |
| role | VARCHAR(10) | CHECK(role IN (‘kol’,‘ol’)) | |
| target | VARCHAR(10) | CHECK(target=‘product’) | 이후 확장 대비 |
| commission_pct | NUMERIC(5,2) | NOT NULL | 예) 30.00 |
| effective_from | DATE | NOT NULL | |
| effective_to | DATE | NULL | 폐기 전 NULL |

• UNIQUE(role, target, effective_from)  
• 현재 적용율 = `effective_from <= today < COALESCE(effective_to,'∞')`

--------------------------------------------------
E. device_commission_tiers (기기 정액 정책)  
--------------------------------------------------
| 컬럼 | 타입 | 제약 | 설명 |
|------|------|------|------|
| id | SERIAL PK | | |
| role | VARCHAR(10) | ‘kol’ \| ‘ol’ |
| tier | VARCHAR(10) | ‘BELOW_5’ \| ‘FROM_5’ |
| fixed_amount | INT | NOT NULL | 개당 지급액 |
| UNIQUE(role,tier) |

초기 데이터 예  
• kol, BELOW_5 = 1500000  
• kol, FROM_5  = 2500000  
• ol 동일

--------------------------------------------------
F. kol_device_accumulators (KOL별 기기 누적)  
--------------------------------------------------
| 컬럼 | 타입 | 제약 | 설명 |
|------|------|------|------|
| kol_id | INT PK FK → kols.id | | |
| total_device_cnt | INT | NOT NULL DEFAULT 0 | |
| updated_at | TIMESTAMPTZ | DEFAULT now() | |

--------------------------------------------------
G. shop_device_allocations (전문점에 기기 추가 레코드)  
--------------------------------------------------
| 컬럼 | 타입 | 제약 | 설명 |
|------|------|------|------|
| id | SERIAL PK | | |
| shop_id | INT FK → shops.id | NOT NULL | |
| kol_id | INT FK → kols.id | NOT NULL |冗장 데이터 |
| allocated_at | DATE | DEFAULT current_date | |
| tier_fixed_amount | INT | NOT NULL | 트리거 계산(150 / 250) |
| user_input_deduct | INT | NOT NULL DEFAULT 0 | 드롭다운 55·34·21 또는 직접 입력 |
| pay_to_kol | INT | NOT NULL | tier_fixed_amount − user_input_deduct |
| note | TEXT | | |
| created_by | INT FK → users.id | | 담당 관리자 |

--------------------------------------------------
H. 핵심 트리거 / 함수  
--------------------------------------------------
1) `tg_after_shop_device_alloc_insert`  
   • 신규 allocation 삽입 → kol_device_accumulators.total_device_cnt +1  
   • 갱신된 누적치가 5 대 미만 → tier = ‘BELOW_5’ (150만)  
     5 대 이상 → ‘FROM_5’ (250만)  
   • `pay_to_kol = tier_fixed_amount - user_input_deduct` 자동 계산

2) `fn_current_product_commission(role, date)`  
   • commission_rate_settings 조회, NULL → 기본값(kol 30, ol 20)

3) 추후 제품 판매 기록 테이블 삽입 시 AFTER INSERT 트리거  
   • 판매액 × 적용 % = 제품 수당 자동 저장

----------------------------------------------
인덱스
----------------------------------------------
• shops.kol_id, kol_device_accumulators.total_device_cnt (HOT update 방지)  
• commission_rate_settings (role, target, effective_from DESC)  
• shop_device_allocations.shop_id, kol_id

========================
2. 전문점 관리 페이지 PRD  
========================

목표  
• KOL/OL 담당자가 관리하는 전문점 CRUD  
• 전문점당 기기 추가(수당 차감 포함) & 제품/매출 요약  
• 관리자(‘admin-new’) 전용

--------------------------------------------------
A. 네비게이션 구조  
--------------------------------------------------
/admin-new  
  └── shops  
      ├── list         (전문점 목록)  
      ├── [shopId]  
      │   ├── detail   (상세&탭)  
      │   └── edit     (정보 수정)  
      └── new          (신규 등록 모달)

--------------------------------------------------
B. 권한  
--------------------------------------------------
• ‘admin-new’ 만 접근 가능 (middleware.ts 이미 구현)  
• RLS 대신 서버 API 레이어에서 재검증

--------------------------------------------------
C. 화면/컴포넌트  
--------------------------------------------------
1) 목록(List)  
   • 검색(상호/지역), KOL 필터, 상태(active/paused)  
   • 테이블 컬럼  
      – 전문점명 / 지역 / KOL이름 / 기기대수 / 최근 기기추가일 / 상태 / 액션(상세·편집)  
   • “전문점 추가” 버튼 → `NewShopDialog`

2) NewShopDialog  
   • 필수: KOL 선택(autocomplete), 상호, 대표자, 지역, 계약일  
   • “기기 함께 추가” 체크 시 → DeviceAllocationSection 활성  
      – 드롭다운: 55·34·21·직접입력  
      – 수량(기본 1) 조정 불가 – 전문점당 기본 1대 ← 향후 확장 고려  
      – 실시간: tier(150/250) – deduct = 예상 지급액 표시  
   • 저장 성공 시 목록 새로고침

3) Detail 페이지  
   상단 카드  
   • 전문점 기본 정보  
   • 담당 KOL, 제품 수당률(override 유/무)  
   중간 탭  
   • 기기 내역 탭 – shop_device_allocations 그리드  
   • 제품 매출 탭 – (추후) 제품 거래 목록 / 합계  
   • 수정 버튼 → EditPage

4) EditPage  
   • 기본 정보 수정  
   • 제품 수당률 override 입력(NUMERIC)  
   • 상태 변경(active|paused)

--------------------------------------------------
D. API 스펙 (예시, /api/admin/shops)  
--------------------------------------------------
• GET /list ?search&kolId&status → 전문점 목록  
• POST /  → 전문점 + (선택) device_allocation 등록  
• GET /:id  → 기본 + 누적 기기수 + 최근 거래 합계  
• PATCH /:id  → 정보 수정  
• POST /:id/device-allocation  → allocation 1건 추가  
• GET /:id/allocations  → allocation 목록(pagination)

모든 POST/PATCH 는 서버에서  
1) 누적 대수 계산  
2) tier_fixed_amount, pay_to_kol 계산  
3) kol_device_accumulators 업데이트  
4) 트랜잭션 commit

--------------------------------------------------
E. 상태 관리  
--------------------------------------------------
• React Query – `['shops', params]`, `['shop', id]`, `['allocations', id]`  
• 낙관적 업데이트는 기기추가 제외(금전 관련) → 성공 응답 후 invalidate

--------------------------------------------------
F. UX 세부  
--------------------------------------------------
• 드롭다운 값 변경 시 실시간 “지급 예정액”을 Bold 표시  
• 직접입력은 숫자만, 0 이상, 1,000,000 단위 제한  
• 누적 5대 경계 진입 시 경고 토스트: “이번 추가부터 지급액이 250만 원으로 변경됩니다.”

--------------------------------------------------
G. 향후 로드맵 (참고)  
--------------------------------------------------
• 제품 매출 입력/수정 화면  
• OL 역할 전용 대시보드  
• 수당 정산 엑셀 다운로드

------------------------
끝.