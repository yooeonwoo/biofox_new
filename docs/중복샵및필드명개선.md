
# BioFox KOL-샵 관계 개선 문서

## 1. 개념 이해와 현재 문제점

### 현재 헷갈렸던 핵심 개념

#### 샵의 유형과 구분
- **KOL 샵**: `is_owner_kol = true`인 샵으로, 샵 자체가 KOL임을 의미합니다.
- **일반 샵**: `is_owner_kol = false`인 샵으로, 일반 전문점을 의미합니다.
- **문제점**: `is_owner_kol` 필드명이 개념을 정확히 반영하지 못하고 있으며, 'owner'가 'KOL 여부'를 나타내는 것인지 '소유 관계'를 나타내는 것인지 혼란스럽습니다.

#### 샵과 KOL의 관계
- **샵의 소속**: 각 샵은 특정 KOL에 소속되어 있으며, 이는 `kol_id` 필드로 표시됩니다.
- **KOL 간 계층 구조**: KOL도 다른 KOL에 소속될 수 있는 계층 구조가 존재합니다.
- **문제점**: `owner_kol_id`와 `kol_id`의 관계가 명확하지 않으며, `relationship_type`이 실제로 무엇을 의미하는지 혼란스럽습니다.

#### 활성 전문점의 정의
- **활성 전문점**: 당월에 매출이 있는 모든 샵(KOL 샵 포함)을 의미합니다.
- **문제점**: 이전에는 활성 전문점 계산 시 `is_owner_kol = true`인 샵을 제외하거나, `relationship_type`에 따라 필터링하는 등 잘못된 방식이 사용되었습니다.

### 예시: 심경선(KOL ID: 48)의 케이스
- 총 7개의 샵 (KOL 샵 3개, 일반 샵 4개)을 보유
- 활성 샵은 2개: 믈리에스킨(KOL 샵, 매출 있음), 마음에점을찍다(일반 샵, 매출 있음)
- 중복된 샵들 존재: 마음에 점을 찍다/마음에점을찍다, 맑음유 에스테틱/맑음유에스테틱

## 2. 개선 방안

### 2.1 데이터베이스 구조 개선

#### 테이블 및 필드명 개선
| 현재 필드 | 개선 필드명 | 설명 |
|----------|------------|------|
| `is_owner_kol` | `is_kol_shop` | KOL인 샵과 일반 샵을 구분하는 용도임을 명확히 함 |
| `owner_kol_id` | `parent_kol_id` | 상위 KOL ID를 의미함을 명확히 함 |
| `relationship_type` | 제거 혹은 `role_type` | 필요시 역할만 명확히 표시 |

#### 새로운 인덱스 및 제약조건
```sql
-- 샵명 중복 방지를 위한 복합 유니크 인덱스
CREATE UNIQUE INDEX shops_kol_id_shop_name_idx ON shops (kol_id, LOWER(TRIM(shop_name)));

-- KOL 자신의 샵임을 보장하는 제약조건
ALTER TABLE shops ADD CONSTRAINT check_kol_shop_parent 
  CHECK (NOT is_kol_shop OR kol_id = parent_kol_id);
```

#### 뷰 생성
```sql
-- 활성 샵 상태를 보여주는 뷰
CREATE OR REPLACE VIEW kol_active_shops_view AS
WITH CurrentMonth AS (
  SELECT MAX(year_month) AS current_month FROM shop_sales_metrics
)
SELECT 
  k.id AS kol_id,
  k.name AS kol_name,
  COUNT(s.id) AS total_shops_count,
  COUNT(CASE WHEN COALESCE(sm.total_sales, 0) > 0 THEN s.id END) AS active_shops_count,
  COUNT(CASE WHEN s.is_kol_shop THEN s.id END) AS kol_shops_count,
  COUNT(CASE WHEN NOT s.is_kol_shop THEN s.id END) AS regular_shops_count
FROM 
  kols k
LEFT JOIN 
  shops s ON k.id = s.kol_id AND s.status = 'active'
LEFT JOIN 
  shop_sales_metrics sm ON s.id = sm.shop_id 
  AND sm.year_month = (SELECT current_month FROM CurrentMonth)
GROUP BY 
  k.id, k.name;
```

### 2.2 API 개선

#### 샵 관련 API 개선
| 현재 API 경로 | 개선 API 경로 | 변경사항 |
|--------------|--------------|----------|
| `/api/kol/{kol_id}/shops` | `/api/kols/{kol_id}/shops` | - 복수형으로 통일<br>- 응답에 샵 유형 명확히 표시<br>- 활성 상태 필드 추가 |
| `/api/shops/{shop_id}` | `/api/shops/{shop_id}` | - 응답에 `is_kol_shop`, `is_active` 필드 추가<br>- `parent_kol` 정보 포함 |

#### 샵 목록 응답 필드 개선
```json
{
  "shops": [
    {
      "id": 107,
      "name": "믈리에스킨",
      "is_kol_shop": true,
      "is_active": true,
      "monthly_sales": 1632400,
      "parent_kol": {
        "id": 48,
        "name": "심경선"
      }
    },
    {
      "id": 112,
      "name": "마음에점을찍다",
      "is_kol_shop": false,
      "is_active": true,
      "monthly_sales": 1716600,
      "parent_kol": null
    }
  ],
  "summary": {
    "total_shops_count": 7,
    "active_shops_count": 2,
    "kol_shops_count": 3,
    "regular_shops_count": 4
  }
}
```

#### 대시보드 API 개선
```json
{
  "dashboard": {
    "kol_id": 48,
    "kol_name": "심경선",
    "year_month": "202505",
    "shops": {
      "total_count": 7,
      "active_count": 2,
      "by_type": {
        "kol_shops": {
          "total": 3,
          "active": 1
        },
        "regular_shops": {
          "total": 4,
          "active": 1
        }
      }
    },
    "sales": {
      // 기존 필드 유지
    }
  }
}
```

### 2.3 프론트엔드 UI 개선

#### 대시보드 화면
- **전문점 요약 섹션 개선**
  - "활성 전문점: 2개 / 전체: 7개" 형식으로 표시
  - 툴팁에 "활성 전문점: 당월 매출이 발생한 전문점" 설명 추가
  - KOL 샵과 일반 샵을 구분하여 표시할 수 있는 토글 추가

#### 전문점 목록 화면
- **필터링 옵션 개선**
  - "모든 전문점", "활성 전문점만", "KOL 샵만", "일반 샵만" 필터 추가
  - 중복 의심 전문점 하이라이트 기능 추가

- **전문점 타입 표시 개선**
  - KOL 샵은 별도 아이콘 또는 태그로 표시
  - 활성/비활성 상태를 색상으로 구분

- **전문점 추가 화면 개선**
  - "전문점 유형" 선택 항목 추가: "KOL 샵", "일반 샵"
  - 샵명 입력 시 중복 검사 및 유사 이름 경고 기능 추가

### 2.4 백엔드 로직 개선

#### 활성 전문점 계산 로직
```typescript
// 활성 전문점 계산 함수
async function calculateActiveShops(kolId: number, yearMonth: string) {
  // 1. 해당 KOL의 모든 샵 조회
  const shops = await getShopsByKolId(kolId);
  
  // 2. 각 샵의 당월 매출 조회
  const shopIds = shops.map(shop => shop.id);
  const salesData = await getShopSalesByMonth(shopIds, yearMonth);
  
  // 3. 활성 샵 계산 (매출 > 0인 모든 샵)
  const activeShops = shops.filter(shop => {
    const shopSales = salesData.find(data => data.shop_id === shop.id);
    return shopSales && shopSales.total_sales > 0;
  });
  
  return {
    total_shops_count: shops.length,
    active_shops_count: activeShops.length,
    kol_shops_count: shops.filter(shop => shop.is_kol_shop).length,
    regular_shops_count: shops.filter(shop => !shop.is_kol_shop).length,
    active_kol_shops_count: activeShops.filter(shop => shop.is_kol_shop).length,
    active_regular_shops_count: activeShops.filter(shop => !shop.is_kol_shop).length
  };
}
```

#### 중복 샵 감지 및 처리 로직
```typescript
// 중복 의심 샵 감지 함수
async function detectDuplicateShops(kolId: number) {
  const shops = await getShopsByKolId(kolId);
  
  // 1. 이름 정규화 (공백, 대소문자, 숫자 등 처리)
  const normalizedShops = shops.map(shop => ({
    ...shop,
    normalized_name: normalizeShopName(shop.shop_name)
  }));
  
  // 2. 정규화된 이름으로 그룹화하여 중복 탐지
  const groupedShops = {};
  normalizedShops.forEach(shop => {
    if (!groupedShops[shop.normalized_name]) {
      groupedShops[shop.normalized_name] = [];
    }
    groupedShops[shop.normalized_name].push(shop);
  });
  
  // 3. 2개 이상인 그룹이 중복 샵
  const duplicates = Object.values(groupedShops)
    .filter(group => group.length > 1);
  
  return duplicates;
}

// 샵명 정규화 함수
function normalizeShopName(name: string) {
  return name
    .toLowerCase()
    .replace(/\s+/g, '') // 모든 공백 제거
    .replace(/\d+$/, '') // 끝의 숫자 제거
    .replace(/[^\w가-힣]/g, ''); // 특수문자 제거
}
```

## 3. 구현 우선순위 및 마이그레이션 계획

### 3.1 우선순위 순서
1. **데이터베이스 필드명 및 주석 개선**
   - 개념을 명확히 하는 것이 가장 우선
   - 기존 `is_owner_kol`의 주석 수정 및 필드 의미 명확화

2. **중복 샵 정리 스크립트 구현**
   - 시스템 개선 전에 기존 데이터 정리 필요
   - 동일 KOL에 속한 유사 이름 샵 감지 및 병합 기능

3. **활성 전문점 계산 로직 개선**
   - 당월 매출 기준으로 활성 전문점 계산 방식 수정
   - `kol_shop_status_view` 뷰 생성

4. **API 응답 형식 개선**
   - 샵 유형과 활성 상태를 명확히 표시하는 응답 형식 적용

5. **UI 개선**
   - 대시보드와 전문점 목록 화면의 표시 방식 개선
   - 필터링 및 정렬 옵션 추가

### 3.2 마이그레이션 계획
1. **데이터 백업**
   - 모든 샵 및 관계 데이터 백업

2. **필드명 변경**
   - `is_owner_kol` → `is_kol_shop` (새 컬럼 추가 후 데이터 이관)
   - `owner_kol_id` → `parent_kol_id` (새 컬럼 추가 후 데이터 이관)

3. **중복 데이터 정리**
   - 감지된 중복 샵 병합 (매출 데이터 유지)
   - 불필요한 relationship_type 필드 정리

4. **코드 업데이트**
   - 새로운 필드명에 맞게 백엔드 코드 수정
   - 활성 전문점 계산 로직 업데이트
   - 프론트엔드 UI 수정

5. **검증 및 배포**
   - 테스트 환경에서 전체 검증 후 프로덕션 배포

## 4. 기대 효과

1. **개념적 명확성**
   - KOL 샵과 일반 샵의 구분이 명확해짐
   - 소속 관계와 샵 유형 구분으로 인한 혼란 제거

2. **데이터 일관성**
   - 중복 샵 감지 및 방지로 데이터 정확성 향상
   - 활성 전문점 수 계산의 일관성 확보

3. **사용자 경험 개선**
   - 직관적인 UI로 KOL의 전문점 현황 파악 용이
   - 필터링 옵션 강화로 다양한 분석 가능

4. **확장성**
   - 명확한 데이터 구조로 향후 기능 확장 용이
   - 샵 계층 구조 및 KOL 간 관계 분석 기반 마련

이 개선안을 통해 BioFox CRM 시스템의 KOL-샵 관계 관리가 더 명확하고 효율적으로 이루어질 것으로 기대됩니다.
