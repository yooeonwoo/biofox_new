아래는 현재까지 정리된 내용을 토대로 **요구사항 명세서(Requirements Specification)** 초안을 작성한 것입니다.  
실제 프로젝트 진행 과정에서 **세부 항목**이나 **우선순위**, **설계 방식** 등이 변동될 수 있으므로,  
팀원들과 협의하여 **지속적으로 업데이트**하면서 사용하시길 권장드립니다.

---

# 요구사항 명세서 (BIOFOX KOL)

## 1. 사용자 및 접근 권한 관련

### 1.1 회원가입 / 로그인

- **화이트리스트 이메일 정책**  
  - 본사에서 **관리자 페이지(UI)**를 통해 신규 이메일을 등록/삭제할 수 있음  
  - 회원가입 시, 사전에 등록된 이메일과 일치하지 않을 경우 “등록된 이메일이 아닙니다” 등의 오류 메시지 노출  
- **권한 검증 방식**  
  - Clerk를 통한 인증 후, **본사 관리자** / **KOL** 중 어느 권한인지 확인  
- **에러 처리(UX/UI)**  
  - 로그인 실패, 접근 권한 불충분 시 상황별 메시지를 표시  
  - 예) “등록되지 않은 이메일입니다.”, “권한이 없습니다.” 등  
- **세션 / 자동 로그인 유지**  
  - 브라우저 쿠키(또는 세션) 기반으로 일정 기간 자동 로그인 유지 가능하도록 설정  
- **추가 요구사항**  
  - (추후) 2FA 등 보안 강화를 고려할 수도 있음 \[*TBD*\]

### 1.2 권한(Role) 및 접근 제어

- **필요한 역할(Roles)**  
  1. **본사 관리자**:  
     - 시스템 전체 접근 가능 (KOL/전문점 등록, 매출/수당 관리, 알림/정산 관리 등)  
  2. **KOL**:  
     - 본인 소속(또는 본인) 매출·수당 조회, 대시보드 접근 가능  
  3. **전문점**:  
     - **로그인 없음** (현재 요구사항에서 전문점은 별도 로그인 불필요)  
- **권한별 접근 제어**  
  - 로그인 후 권한에 따라 **자동 리다이렉트** (예: 관리자 → 관리자 페이지, KOL → KOL 대시보드)  
  - **본인 ID**에 해당하는 데이터만 조회 (KOL은 본인·소속 전문점 데이터만)  
- **권한 테이블 동적 변경**  
  - 본사 관리자가 새로운 권한, 혹은 기존 권한 수정/삭제를 할 수 있는 구조 **필요**  
  - 다만, 현재는 “본사/관리자”, “KOL”만 로그인이 발생하므로 간단한 RBAC(Role-Based Access Control) 구현 가능

---

## 2. KOL/전문점 관리 & 데이터 구조

### 2.1 KOL 등록/관리

- **KOL 정보 필드**  
  - KOL 원장님 이름  
  - KOL 샵 이름  
  - 이메일  
  - 전화번호 \[*TBD*\]  
  - 소속 전문점 목록(1:N 관계)  
- **필수 입력 항목**  
  - 원장님 이름, 샵 이름, 이메일  
- **KOL - 전문점 관계**  
  - **1:N** 구조 (한 KOL이 여러 전문점을 보유 가능)  
  - **한 전문점은 한 KOL**에만 소속  
  - KOL 본인도 “전문점”이 될 수 있음 (자기 매출/수당 발생)  
  - 한 KOL이 다른 KOL의 전문점으로도 등록될 수 있음 (순환 구조 가능성)  
  - \[주의\] 이런 구조를 DB에서 어떻게 모델링할지 설계 필요 (Self join 등)

### 2.2 전문점 관리

- **전문점 정보 필드**  
  - 전문점 이름  
  - 전문점 원장님 이름  
  - 소속 KOL (외래키)  
- **등록/수정/삭제 절차(권한)**  
  - **본사 관리자** 권한만 가능  
- **소속 구조 확장 가능성**  
  - “하위 전문점” 개념은 없음.  
  - 단, 전문점이 독립적으로 KOL 역할을 할 가능성은 존재 (위에서 언급된 순환 구조)

### 2.3 데이터 구조(테이블)

- **예상 테이블**  
  1. **users** (Clerk와 연동 or 자체 DB)  
     - id, role, email, etc.  
  2. **kol** (KOL별 상세 정보)  
     - kol_id, 이름, 샵 이름, email(FK → users), 전화번호 등  
  3. **shops** (전문점)  
     - shop_id, 이름, 원장님 이름, fk_kol_id 등  
  4. **products** / **devices** (기기 / 일반 제품 분리)  
     - 예) devices 테이블(기기명, 기기단가, 수당구간 등), products 테이블(제품명, 단가 등)  
  5. **orders**  
     - Cafe24 주문 정보 (주문번호, 주문일, 해당 shop, 주문 제품 내역 등)  
  6. **commissions** (수당 계산 결과)  
     - commission_id, kol_id, 매출(금액), 계산된 수당, 정산 상태 등  
- **기기 vs 일반 제품**  
  - “기기는 누적 4대 이하이면 대당 150만원, 5대 이상이면 대당 250만원”  
  - “일반 제품은 매출의 30%” → 별도의 로직으로 수당 계산

---

## 3. Cafe24 & n8n 연동 (주문 → 매출 → 수당)

### 3.1 Cafe24 API 연동

- **사용 API Endpoint**  
  - 주문 정보 조회(신규 주문, 결제 완료 등)  
  - (필요 시) 상품 정보 조회  
- **연동 주기**  
  - **실시간**: 웹훅 혹은 이벤트 기반 (주문 발생 시 Cafe24가 n8n으로 알림)  
  - n8n에서 받은 정보 → Supabase DB 저장  
- **API 호출 제한 & 보안**  
  - Cafe24 Developer 정책 준수(토큰 관리, Rate Limit 등)  
  - \[*상세 스펙은 Cafe24 문서 참고*\]

### 3.2 n8n을 통한 워크플로우 자동화

- **워크플로우 트리거**  
  - Cafe24 → (웹훅) → n8n → Supabase  
  - 주문 발생 시 n8n이 해당 정보를 받아 DB 갱신 + 수당 계산 로직 수행  
- **수당 계산 로직**  
  - **기기**: 누적 4대 이하 → 대당 150만원 / 5대 이상 → 대당 250만원  
  - **일반 제품**: 매출의 30% → KOL 수당으로 계산  
  - 전문점 자체에는 수당 없음 (매출만 기록), KOL에만 수당 표시  
- **오류/알림 처리**  
  - API 실패, 계산 로직 오류 시, n8n 워크플로우에서 **오류 알림**(이메일/슬랙/내부 알림)  
  - 재시도 정책(주문 정보 재수신)을 둘 것인지 \[*TBD*\]

### 3.3 매출/수당 계산

- **세부 항목**  
  - 주문번호, 구매 제품(또는 기기) 정보, 구매 수량, 결제금액, 할인정보 \[*TBD*\]  
- **정산 주기**  
  - 주문 완료 시 **자동** 반영 (실시간)  
  - 별도의 월간·분기별 정산 프로세스가 있다면 \[*추가 협의*\]

---

## 4. 대시보드 요구사항

> (추후 **대시보드 상세 페이지 명세서**에서 구체화할 예정)

### 4.1 본사 대시보드

- **표시 지표**  
  - 전체 매출 추이, KOL별 매출 요약, 전문점 현황  
  - 최근 주문(주문번호, 결제 상태, 금액 등)  
  - 수당 정산 상태(정산 완료/미완료) 시각화 (색상표기, 태그 등)  
- **필터링/검색 기능**  
  - 날짜/주문상태/KOL명/전문점명/주문번호 등으로 검색 or 필터링  
- **알림 기능**  
  - 주문 발생, 정산 상태 변경 시 본사 관리자에게 알림

### 4.2 KOL 대시보드

- **개인 매출/수당 요약**  
  - 그래프/차트(일/주/월) + 테이블  
- **소속 전문점 매출 집계**  
  - 전문점별 매출 금액, 주문 건수 등  
- **예상 수당 / 정산 상태**  
  - (정산 완료 / 미정산 등) 알림 표시  
- **필터링/검색**  
  - 특정 기간, 주문 번호, 전문점명 등 조회

---

## 5. 관리자 페이지(본사) 기능 상세

### 5.1 계정(회원) 관리

- **KOL/전문점 사용자 생성/수정/삭제**  
  - 본사 관리자가 UI에서 등록(이름, 이메일, 권한, 소속 KOL 등)  
  - 전문점은 로그인 불가이므로 사용자 테이블 등록 시 role=“shop”은 제외 or 별도 테이블로 관리 \[*TBD*\]  
- **추가 권한(일반 직원)**  
  - 필요 시 role=“staff” 등이 생성될 수 있음 (기능 제한)

### 5.2 정산 기능

- **수동 정산**  
  - 지급 일자, 금액, 받는 사람(KOL), 지급 메모(계좌 정보 등) 기록  
  - 정산 완료/미완료 상태 업데이트  
  - 히스토리(이력) 보관 (언제 누구에게 얼마 지급)  
- **자동 정산과의 관계**  
  - 주문→자동 수당 계산 완료 후, 실제 지급 행위는 수동으로 처리  
  - 지급 처리가 완료되면 시스템에 “정산 완료”로 표시

### 5.3 알림/공지 관리

- **KOL 대상 공지**  
  - 앱 내 알림(실시간) or 알림 센터(대시보드)  
- **본사 관리자 알림**  
  - 주문 발생, 수당 계산 오류, 정산 상태 변경 등 실시간 알림  
- **구현 방식**  
  - 클라이언트(Next.js) 측 WebSocket/Pusher/Supabase Realtime 등 \[*TBD*\]

---

## 6. 비기능 요구사항

### 6.1 성능 및 트래픽

- **예상 동시 접속자 수**: \[*TBD*\]  
- **주문 처리량**: 일 평균 \[*TBD*\] 건 (Cafe24에서 넘어오는 주문)  
- **목표 성능**  
  - 페이지 로드 2~3초 이내, DB 응답 1초 이내 \[*구체화 필요*\]

### 6.2 보안

- **데이터 전송/암호화**  
  - HTTPS 필수, Clerk 인증(Access Token), DB 접근 권한 최소화  
- **추가 보안(2FA, IP 화이트리스트 등)**  
  - 현재는 별도 요구 없음. 차후 고려 가능  
- **권한 오남용 방지**  
  - RBAC 정확한 적용 (본사, KOL)  
  - 전문점은 DB 레벨에서만 관리 (로그인 X)

### 6.3 가용성 & 장애 대응

- **장애/재시도 정책**  
  - Cafe24 API 혹은 n8n 장애 시 주문 동기화 지연 가능 → 재시도 로직 필요  
- **백업/복구**  
  - Supabase DB 백업 주기, n8n 설정 백업  
  - (중요) 데이터 유실 대비 대책

---

## 7. 테스트 & QA

### 7.1 테스트 범위

- **단위 테스트**  
  - 주요 함수(수당 계산, 권한 체크 등)  
- **통합 테스트**  
  - Cafe24 → n8n → Supabase 연동 시나리오  
  - 회원가입/로그인 → 권한별 대시보드 접근  
- **E2E 테스트**  
  - (예) Cypress를 이용해 실제 브라우저 시나리오 테스트

### 7.2 테스트 시나리오

- **정상 케이스**  
  - (1) KOL 신규 등록 → Cafe24에서 주문 발생 → DB에 매출/수당 생성 → KOL 대시보드 확인  
- **예외 케이스**  
  - (1) 주문 취소/환불 시 수당/매출 재계산  
  - (2) Cafe24 API 호출 실패/재시도  
  - (3) 화이트리스트에 없는 이메일 가입 시도 → 오류 메시지  
  - (4) 중복 주문번호 수신  
- **QA 프로세스**  
  - QA 담당자 \[*TBD*\], 버그 관리(깃허브 이슈/Jira)로 추적

---

## 8. 시스템 운영 & 유지보수

### 8.1 배포 환경

- **호스팅**: Vercel (프론트엔드 / Next.js)  
- **CI/CD**:  
  - GitHub Actions or Vercel 자동 빌드 → 배포 파이프라인  
  - 최소 기능 브랜치(Minimal Feature Branch) 전략 \[*TBD*\]

### 8.2 로그/모니터링

- **실시간 에러 추적**  
  - (예) Sentry, Supabase 모니터링  
- **API/DB 로그**  
  - Cafe24 API 호출 로그, n8n 워크플로우 로그  
- **감사 로그(Audit Log)**  
  - 본사 / KOL 주요 액션(정산, 등록/삭제 등) 기록 여부 \[*TBD*\]

### 8.3 버전 관리

- **Git 브랜치 전략**  
  - 메인 + 기능별 브랜치, 기능 완성 시 PR & 코드리뷰 → 메인에 Merge  
- **릴리스 노트**  
  - 주요 업데이트(기능 추가/변경/버그 수정) 시 기록

---

## 9. 리스크 관리 & 추가 고려 사항

### 9.1 리스크 대응

- **Cafe24 API 변경/지연**  
  - n8n 워크플로우에서 API 에러 발생 시 재시도 + 관리자 알림  
- **서버 비용**  
  - n8n 클라우드 유료 플랜, Supabase 요금 초과 시 대안(온프레미스 설치, 증설 등)

### 9.2 추가 기능 확장

- **전문점 로그인/페이지**  
  - 현재는 불필요. 추후 필요 시 확장 가능  
- **다국어, 타 플랫폼 연동(Shopify, 고도몰 등)**  
  - 향후 글로벌/다중몰 지원이 필요하다면 구조 확장 검토

### 9.3 UI/UX 확장

- **고급 분석/리포트**  
  - 대시보드에 다양한 차트, KPI 지표 추가 가능  
- **모바일 대응**  
  - 반응형 웹 우선 / 추후 전용 앱 검토

---

## 10. 우선순위 및 일정 세부 조율

### 10.1 우선순위 명확화

- **필수 기능**(MVP)  
  1. 회원가입/로그인(화이트리스트), 권한 분기(본사/ KOL)  
  2. KOL/전문점 등록 & 관리(본사)  
  3. Cafe24 → 주문 연동 + n8n 자동 수당 계산 (기기/제품 구분)  
  4. KOL 대시보드(매출/수당 조회)  
  5. 본사 대시보드(전체 매출, KOL별 매출, 전문점 현황, 정산 관리)  
- **선택 기능**(추후)  
  - 고급 통계/리포트, 알림 고도화(푸시, 이메일), 전문점 독립 페이지, 모바일 앱, 다국어 지원 등

### 10.2 스프린트 계획 & 마일스톤

1. **스프린트 1**:  
   - 회원가입/로그인 & 권한 구조 설정, DB 스키마 설계  
2. **스프린트 2**:  
   - Cafe24 연동 & 수당 계산 로직(n8n) PoC  
   - KOL/전문점 등록/관리(기본 UI)  
3. **스프린트 3**:  
   - 대시보드(본사/KOL) 1차 구현, 정산(수동) 기능  
   - 알림(기본)  
4. **베타 테스트**:  
   - 실제 KOL 일부 대상 운영, 피드백 수렴  
5. **정식 출시**:  
   - 고도화된 기능(필요 시), 버그 수정, 성능 튜닝

### 10.3 팀 리소스

- **개발자/디자이너 투입 시점** \[*TBD*\]  
- **QA 전담**: MVP 또는 베타 전후에 집중 테스트  
- **외부 협력**: Cafe24, n8n 기술 지원 필요 시 **개발 기간 중** 진행

---

## 정리

이 **요구사항 명세서**는 BIOFOX KOL 프로젝트의 기능·비기능 요구사항을 종합한 초안입니다.  
- **기능 요구사항**: 회원가입(화이트리스트), 권한별 접근, KOL/전문점 관리, Cafe24→n8n→Supabase 연동, 기기·제품 수당 계산, 대시보드, 정산 관리, 알림 등  
- **비기능 요구사항**: 성능(실시간 동기화), 보안(HTTPS, RBAC), 모니터링, 장애 대응, CI/CD, 팀 협업 방식 등  
- **우선순위/일정**: MVP → 베타 테스트 → 정식 출시 순으로 기능을 점진적으로 완성  

실제로 개발이 진행되면서, **테스트/QA 결과**나 **비즈니스 요건 변경**에 따라 요구사항은 계속 보완될 수 있습니다.  
각 스프린트마다 **우선순위 및 세부 설계**를 재확인하고, 이 문서도 **지속적으로 업데이트**하시기 바랍니다.