다음은 요청하신 내용을 토대로 Next.js API Routes로 구현하기 위한 데이터베이스 스키마 및 설계 명세서입니다. 기존 데이터베이스 스키마를 참고해 새롭게 추가하거나 변경이 필요한 부분을 반영했습니다.

---

## 🔖 데이터베이스 설계 명세서

### **기존 테이블 활용**

기존의 다음 테이블을 활용합니다:

- **products (제품 정보)**
  - 제품 종류, 가격 정보 활용

- **shops (전문점 정보)**
  - 전문점 정보, kol과의 연결 정보 활용

- **orders (주문 정보)**
  - 주문 총액, 날짜, 상태 관리

- **order_items (주문 제품 정보)**
  - 개별 주문 제품의 수량, 가격 정보 관리

- **kols (KOL 정보)**
  - KOL 기본 정보 관리 (이름, 소속 등)

---

### **새로 추가 또는 변경할 테이블**

#### 🟢 **monthly_sales (월별 매출 및 수당 관리 테이블)**

| 필드명             | 타입             | 설명                                      |
| ------------------ | ---------------- | ----------------------------------------- |
| id                 | integer (PK)     | 고유 식별자                               |
| kol_id             | integer (FK)     | KOL ID                                    |
| shop_id            | integer (FK)     | 전문점 ID                                 |
| year_month         | varchar          | 관리연월 (ex. "2025-03")                  |
| product_sales      | integer          | 제품 매출 합계 (기기 제외)                |
| device_sales       | integer          | 기기 매출 합계                            |
| total_sales        | integer          | 총 매출 (제품+기기)                       |
| commission         | integer          | 수당 합계 (30% of 제품매출 + 기기수당 별도)|
| created_at         | timestamp        | 생성일자                                  |
| updated_at         | timestamp        | 수정일자                                  |

- 제품 매출과 기기 매출을 별도로 관리합니다.
- KOL의 수당은 제품 매출의 30%이며, 기기수당은 별도 항목으로 추가 관리됩니다.

---

#### 🟢 **product_sales_ratios (제품별 매출 비율 테이블)**

| 필드명             | 타입             | 설명                                 |
| ------------------ | ---------------- | ------------------------------------ |
| id                 | integer (PK)     | 고유 식별자                          |
| shop_id            | integer (FK)     | 전문점 ID                            |
| kol_id             | integer (FK)     | KOL ID                               |
| year_month         | varchar          | 관리연월 (ex. "2025-03")             |
| product_id         | integer (FK)     | 제품 ID                              |
| sales_amount       | integer          | 제품별 매출 합계                     |
| sales_ratio        | float            | 해당 월 제품별 매출 비율 (0~1)       |
| created_at         | timestamp        | 생성일자                             |
| updated_at         | timestamp        | 수정일자                             |

- 전문점과 KOL별 제품 매출 비율을 월별로 관리합니다.

---

#### 🟢 **kol_hierarchy (KOL 계층 구조 테이블)**

| 필드명             | 타입             | 설명                                 |
| ------------------ | ---------------- | ------------------------------------ |
| id                 | integer (PK)     | 고유 식별자                          |
| parent_kol_id      | integer (FK)     | 상위 KOL ID (nullable)               |
| child_kol_id       | integer (FK)     | 하위 KOL ID                          |
| child_start_month  | varchar          | 하위 KOL 시작 연월 (ex. "2025-03")   |
| created_at         | timestamp        | 생성일자                             |
| updated_at         | timestamp        | 수정일자                             |

- 하위 KOL 등록 후 첫 달 매출의 10%를 상위 KOL에게 수당으로 지급합니다.

---

#### 🟢 **kol_monthly_summary (KOL 월별 요약 테이블)**

| 필드명                  | 타입             | 설명                                     |
| ----------------------- | ---------------- | ---------------------------------------- |
| id                      | integer (PK)     | 고유 식별자                              |
| kol_id                  | integer (FK)     | KOL ID                                   |
| year_month              | varchar          | 관리연월 (ex. "2025-03")                 |
| monthly_sales           | integer          | 당월 매출                                |
| monthly_commission      | integer          | 당월 수당                                |
| avg_monthly_sales       | float            | 월평균 매출 (최근 3개월 기준)            |
| cumulative_commission   | integer          | 누적 수당                                |
| previous_month_sales    | integer          | 전월 매출                                |
| previous_month_commission | integer        | 전월 수당                                |
| active_shops_count      | integer          | 당월 주문이 있는 전문점 수               |
| total_shops_count       | integer          | 소속된 전체 전문점 수                    |
| created_at              | timestamp        | 생성일자                                 |
| updated_at              | timestamp        | 수정일자                                 |

- 월별 KOL의 매출 및 수당을 요약하여 관리합니다.
- 전월과 당월의 매출, 수당 비교가 가능합니다.

---

### API Routes (Next.js 기준 예시)

#### 🔹 `/api/sales/monthly-summary`
- KOL의 월별 매출, 수당, 전월 대비 비교 데이터 제공

#### 🔹 `/api/sales/product-ratios`
- 전문점/KOL별 월간 제품 매출 비율 데이터 제공

#### 🔹 `/api/sales/shop-ranking`
- 전문점 순위 데이터 제공 (월평균매출, 당월매출, 누적매출 기준)

#### 🔹 `/api/sales/shop-details/[shopId]`
- 특정 전문점의 월별 제품 비율 및 매출/수당 상세 데이터 제공

#### 🔹 `/api/sales/register`
- 주문 정보를 바탕으로 월별 매출, 수당 데이터를 계산 및 저장

---

### 💡 로직 정리

- **제품 수당**: 제품 매출 × 30%
- **기기 수당**: 별도 지정된 수당 계산
- **하위 KOL 첫 달 수당**: 하위 KOL의 첫 달 매출 × 10%를 상위 KOL에게 지급

---

이 설계는 Next.js API Routes 및 React UI와 긴밀히 연결되어 있으며, 데이터는 Supabase 또는 PostgreSQL 환경에서 운용됩니다. 필요에 따라 프론트엔드에서 `useSWR` 혹은 `react-query` 등을 이용하여 데이터 fetching을 최적화할 수 있습니다.

위 설계를 기반으로 개발을 진행하시면, 요구하신 기능이 원활하게 동작하게 됩니다. 추가적으로 필요한 부분이 있다면 구체적으로 말씀해 주세요.