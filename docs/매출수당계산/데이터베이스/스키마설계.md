# 매출수당계산 데이터베이스 스키마 설계

## 1. 개요

매출수당계산 기능을 위한 데이터베이스 스키마 설계 문서입니다. 기존 테이블을 활용하고 새로운 테이블을 추가하여 요구사항에 맞는 시스템을 구현합니다.

## 2. 기존 테이블 활용

기존의 다음 테이블을 활용합니다:

### **users (사용자 정보)**
- 사용자 인증 및 기본 정보 관리

### **kols (KOL 정보)**
- KOL 기본 정보 관리 (이름, 소속 등)
- 기존 스키마:
```typescript
export const kols = pgTable("kols", {
  id: serial("id").primaryKey(),
  userId: integer("user_id").references(() => users.id).notNull(),
  name: varchar("name", { length: 255 }).notNull(),
  shopName: varchar("shop_name", { length: 255 }).notNull(),
  region: varchar("region", { length: 100 }),
  smartPlaceLink: varchar("smart_place_link", { length: 500 }),
  status: varchar("status", { length: 50 }).default("active").notNull(),
  createdAt: timestamp("created_at").defaultNow().notNull(),
  updatedAt: timestamp("updated_at").defaultNow().notNull()
});
```

### **shops (전문점 정보)**
- 전문점 정보, KOL과의 연결 정보 관리
- 기존 스키마:
```typescript
export const shops = pgTable("shops", {
  id: serial("id").primaryKey(),
  kolId: integer("kol_id").references(() => kols.id).notNull(),
  ownerName: varchar("owner_name", { length: 255 }).notNull(),
  region: varchar("region", { length: 100 }),
  smartPlaceLink: varchar("smart_place_link", { length: 500 }),
  status: varchar("status", { length: 50 }).default("active").notNull(),
  createdAt: timestamp("created_at").defaultNow().notNull(),
  updatedAt: timestamp("updated_at").defaultNow().notNull()
});
```

### **products (제품 정보)**
- 제품 종류, 가격 정보 관리
- 기존 스키마:
```typescript
export const products = pgTable("products", {
  id: serial("id").primaryKey(),
  name: varchar("name", { length: 255 }).notNull(),
  price: integer("price").notNull(),
  isDevice: boolean("is_device").default(false).notNull(), // 기기(true) 또는 일반 제품(false)
  description: text("description"),
  image: varchar("image", { length: 500 }),
  category: varchar("category", { length: 100 }),
  status: varchar("status", { length: 50 }).default("active").notNull(),
  createdAt: timestamp("created_at").defaultNow().notNull(),
  updatedAt: timestamp("updated_at").defaultNow().notNull()
});
```

### **orders (주문 정보)**
- 주문 총액, 날짜, 상태 관리
- 기존 스키마:
```typescript
export const orders = pgTable("orders", {
  id: serial("id").primaryKey(),
  orderNumber: varchar("order_number", { length: 255 }).notNull().unique(),
  shopId: integer("shop_id").references(() => shops.id).notNull(),
  totalAmount: integer("total_amount").notNull(),
  status: varchar("status", { length: 50 }).default("pending").notNull(),
  orderDate: timestamp("order_date").defaultNow().notNull(),
  paymentMethod: varchar("payment_method", { length: 100 }),
  paymentStatus: varchar("payment_status", { length: 50 }).default("pending").notNull(),
  createdAt: timestamp("created_at").defaultNow().notNull(),
  updatedAt: timestamp("updated_at").defaultNow().notNull()
});
```

### **order_items (주문 제품 정보)**
- 개별 주문 제품의 수량, 가격 정보 관리
- 기존 스키마:
```typescript
export const orderItems = pgTable("order_items", {
  id: serial("id").primaryKey(),
  orderId: integer("order_id").references(() => orders.id).notNull(),
  productId: integer("product_id").references(() => products.id).notNull(),
  quantity: integer("quantity").notNull(),
  price: integer("price").notNull(),
  createdAt: timestamp("created_at").defaultNow().notNull(),
  updatedAt: timestamp("updated_at").defaultNow().notNull()
});
```

### **commissions (수당 정보)**
- 주문별 수당 정보 관리
- 기존 스키마:
```typescript
export const commissions = pgTable("commissions", {
  id: serial("id").primaryKey(),
  kolId: integer("kol_id").references(() => kols.id).notNull(),
  orderId: integer("order_id").references(() => orders.id).notNull(),
  amount: integer("amount").notNull(),
  settled: boolean("settled").default(false).notNull(),
  settledDate: timestamp("settled_date"),
  settledNote: varchar("settled_note", { length: 500 }),
  createdAt: timestamp("created_at").defaultNow().notNull(),
  updatedAt: timestamp("updated_at").defaultNow().notNull()
});
```

## 3. 새로운 테이블 설계

### **monthly_sales (월별 매출 및 수당 관리 테이블)**

```typescript
export const monthlySales = pgTable("monthly_sales", {
  id: serial("id").primaryKey(),
  kolId: integer("kol_id").references(() => kols.id).notNull(),
  shopId: integer("shop_id").references(() => shops.id).notNull(),
  yearMonth: varchar("year_month", { length: 7 }).notNull(), // 관리연월 (예: "2023-08")
  productSales: integer("product_sales").notNull().default(0), // 제품 매출 합계 (기기 제외)
  deviceSales: integer("device_sales").notNull().default(0), // 기기 매출 합계
  totalSales: integer("total_sales").notNull().default(0), // 총 매출 (제품+기기)
  commission: integer("commission").notNull().default(0), // 수당 합계
  createdAt: timestamp("created_at").defaultNow().notNull(),
  updatedAt: timestamp("updated_at").defaultNow().notNull()
});

// 인덱스 추가
export const monthlySalesIndex = index("monthly_sales_kol_shop_month_idx")
  .on(monthlySales)
  .columns([monthlySales.kolId, monthlySales.shopId, monthlySales.yearMonth]);
```

### **product_sales_ratios (제품별 매출 비율 테이블)**

```typescript
export const productSalesRatios = pgTable("product_sales_ratios", {
  id: serial("id").primaryKey(),
  shopId: integer("shop_id").references(() => shops.id).notNull(),
  kolId: integer("kol_id").references(() => kols.id).notNull(),
  yearMonth: varchar("year_month", { length: 7 }).notNull(), // 관리연월 (예: "2023-08")
  productId: integer("product_id").references(() => products.id).notNull(),
  salesAmount: integer("sales_amount").notNull().default(0), // 제품별 매출 합계
  salesRatio: numeric("sales_ratio", { precision: 5, scale: 4 }).notNull().default("0"), // 해당 월 제품별 매출 비율 (0~1)
  createdAt: timestamp("created_at").defaultNow().notNull(),
  updatedAt: timestamp("updated_at").defaultNow().notNull()
});

// 인덱스 추가
export const productSalesRatiosIndex = index("product_sales_ratios_shop_month_product_idx")
  .on(productSalesRatios)
  .columns([productSalesRatios.shopId, productSalesRatios.yearMonth, productSalesRatios.productId]);
```

### **kol_hierarchy (KOL 계층 구조 테이블)**

```typescript
export const kolHierarchy = pgTable("kol_hierarchy", {
  id: serial("id").primaryKey(),
  parentKolId: integer("parent_kol_id").references(() => kols.id).notNull(),
  childKolId: integer("child_kol_id").references(() => kols.id).notNull(),
  childStartMonth: varchar("child_start_month", { length: 7 }).notNull(), // 하위 KOL 시작 연월 (예: "2023-08")
  isFirstMonthPaid: boolean("is_first_month_paid").default(false).notNull(), // 첫 달 수당 지급 여부
  createdAt: timestamp("created_at").defaultNow().notNull(),
  updatedAt: timestamp("updated_at").defaultNow().notNull()
});

// 인덱스 추가
export const kolHierarchyParentChildIndex = index("kol_hierarchy_parent_child_idx")
  .on(kolHierarchy)
  .columns([kolHierarchy.parentKolId, kolHierarchy.childKolId]);
```

### **kol_monthly_summary (KOL 월별 요약 테이블)**

```typescript
export const kolMonthlySummary = pgTable("kol_monthly_summary", {
  id: serial("id").primaryKey(),
  kolId: integer("kol_id").references(() => kols.id).notNull(),
  yearMonth: varchar("year_month", { length: 7 }).notNull(), // 관리연월 (예: "2023-08")
  monthlySales: integer("monthly_sales").notNull().default(0), // 당월 매출
  monthlyCommission: integer("monthly_commission").notNull().default(0), // 당월 수당
  avgMonthlySales: numeric("avg_monthly_sales", { precision: 12, scale: 2 }).notNull().default("0"), // 월평균 매출 (최근 3개월 기준)
  cumulativeCommission: integer("cumulative_commission").notNull().default(0), // 누적 수당
  previousMonthSales: integer("previous_month_sales").notNull().default(0), // 전월 매출
  previousMonthCommission: integer("previous_month_commission").notNull().default(0), // 전월 수당
  activeShopsCount: integer("active_shops_count").notNull().default(0), // 당월 주문이 있는 전문점 수
  totalShopsCount: integer("total_shops_count").notNull().default(0), // 소속된 전체 전문점 수
  createdAt: timestamp("created_at").defaultNow().notNull(),
  updatedAt: timestamp("updated_at").defaultNow().notNull()
});

// 인덱스 추가
export const kolMonthlySummaryIndex = index("kol_monthly_summary_kol_month_idx")
  .on(kolMonthlySummary)
  .columns([kolMonthlySummary.kolId, kolMonthlySummary.yearMonth]);
```

### **device_count_summary (기기 누적 대수 관리 테이블)**

```typescript
export const deviceCountSummary = pgTable("device_count_summary", {
  id: serial("id").primaryKey(),
  kolId: integer("kol_id").references(() => kols.id).notNull(),
  cumulativeCount: integer("cumulative_count").notNull().default(0), // 누적 기기 대수
  createdAt: timestamp("created_at").defaultNow().notNull(),
  updatedAt: timestamp("updated_at").defaultNow().notNull()
});

// 인덱스 추가
export const deviceCountSummaryIndex = index("device_count_summary_kol_idx")
  .on(deviceCountSummary)
  .columns([deviceCountSummary.kolId]);
```

## 4. 테이블 간의 관계

### monthlySales 관계 정의

```typescript
export const monthlySalesRelations = relations(monthlySales, ({ one }) => ({
  kol: one(kols, {
    fields: [monthlySales.kolId],
    references: [kols.id],
  }),
  shop: one(shops, {
    fields: [monthlySales.shopId],
    references: [shops.id],
  }),
}));
```

### productSalesRatios 관계 정의

```typescript
export const productSalesRatiosRelations = relations(productSalesRatios, ({ one }) => ({
  kol: one(kols, {
    fields: [productSalesRatios.kolId],
    references: [kols.id],
  }),
  shop: one(shops, {
    fields: [productSalesRatios.shopId],
    references: [shops.id],
  }),
  product: one(products, {
    fields: [productSalesRatios.productId],
    references: [products.id],
  }),
}));
```

### kolHierarchy 관계 정의

```typescript
export const kolHierarchyRelations = relations(kolHierarchy, ({ one }) => ({
  parentKol: one(kols, {
    fields: [kolHierarchy.parentKolId],
    references: [kols.id],
    relationName: "parentKol",
  }),
  childKol: one(kols, {
    fields: [kolHierarchy.childKolId],
    references: [kols.id],
    relationName: "childKol",
  }),
}));
```

### kolMonthlySummary 관계 정의

```typescript
export const kolMonthlySummaryRelations = relations(kolMonthlySummary, ({ one }) => ({
  kol: one(kols, {
    fields: [kolMonthlySummary.kolId],
    references: [kols.id],
  }),
}));
```

### deviceCountSummary 관계 정의

```typescript
export const deviceCountSummaryRelations = relations(deviceCountSummary, ({ one }) => ({
  kol: one(kols, {
    fields: [deviceCountSummary.kolId],
    references: [kols.id],
  }),
}));
```

## 5. 제품 정보 및 수당 계산 로직

### 5.1 제품 목록 및 가격

| 제품명 | 가격 |
|-------|------|
| 큐어부스터 | 74,800원 |
| 올인원세럼 | 77,000원 |
| V앰플 | 220,000원 |
| 퓨어솔루션 | 418,000원 |
| 마이크로젯 부스터 | 149,000원 |

### 5.2 수당 계산 로직

- **제품 수당**: 제품 매출 × 30% (모든 제품에 동일하게 적용)
- **기기 수당**: 마이크로젯만 해당
  - 누적 4대 이하: 대당 1,500,000원
  - 누적 5대 이상: 대당 2,500,000원
- **하위 KOL 첫 달 수당**: 하위 KOL의 첫 달 모든 소속 전문점 매출 합계의 10%를 상위 KOL에게 지급
- **부가세**: 모든 계산에서 부가세는 제외 