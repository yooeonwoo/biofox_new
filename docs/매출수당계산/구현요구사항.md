
 **Next.js**만으로 `주문 → 매출 → 수당 계산 → DB 저장`까지 전부 구현하려면, 아래와 같은 방식으로 시스템을 구성하면 됩니다.

---

## ✅ 전체 구성 요약 (Next.js만으로 구현할 경우)

```
[Cafe24] → [Next.js API Route] → [Supabase]  
           └→ 주문 저장 & 수당 계산 로직 실행
```

---

## 1. **Cafe24 → Next.js로 주문 정보 받기**

### ✅ 방법: **Cafe24 Webhook** 사용

1. **Cafe24 관리자에서 Webhook 등록**
   - 주문 발생 시(예: 결제 완료) 호출할 **URL**을 설정:  
     ```
     https://yourdomain.com/api/webhook/cafe24
     ```

2. **Next.js API Route 구현**

```ts
// pages/api/webhook/cafe24.ts
import { NextApiRequest, NextApiResponse } from 'next';
import { supabase } from '@/lib/supabase';
import { calculateCommission } from '@/lib/commission';

export default async function handler(req: NextApiRequest, res: NextApiResponse) {
  if (req.method !== 'POST') return res.status(405).end();

  const orderData = req.body;

  try {
    // 1. 주문 저장
    const { data: order, error: orderError } = await supabase.from('orders').insert({
      order_number: orderData.order_no,
      shop_id: await findShopId(orderData.receiver.name),
      total_amount: orderData.total_price,
      order_date: new Date(),
      status: 'paid',
      payment_status: 'paid',
    }).select().single();

    if (orderError) throw orderError;

    // 2. 아이템 저장 + 수당 계산
    for (const item of orderData.items) {
      const { data: product } = await supabase.from('products').select('*').eq('id', item.product_id).single();
      const itemAmount = item.price * item.quantity;

      await supabase.from('order_items').insert({
        order_id: order.id,
        product_id: item.product_id,
        quantity: item.quantity,
        price: item.price,
      });

      const commissionAmount = await calculateCommission(product, item.quantity, itemAmount, order.shop_id);
      const kolId = await findKOLId(order.shop_id);

      await supabase.from('commissions').insert({
        kol_id: kolId,
        order_id: order.id,
        amount: commissionAmount,
        settled: false,
      });
    }

    res.status(200).json({ success: true });
  } catch (err) {
    console.error('Cafe24 Webhook Error:', err);
    res.status(500).json({ error: 'Internal server error' });
  }
}
```

---

## 2. **수당 계산 함수 분리 (`lib/commission.ts`)**

```ts
export async function calculateCommission(product, quantity, total, shop_id) {
  if (product.is_device) {
    const kolId = await findKOLId(shop_id);
    const { count } = await supabase
      .from('order_items')
      .select('*', { count: 'exact', head: true })
      .eq('product_id', product.id)
      .eq('shop_id', shop_id); // 또는 KOL 기준으로 필터

    const isOver4 = count >= 5;
    const rate = isOver4 ? 2500000 : 1500000;
    return rate * quantity;
  } else {
    return total * 0.3;
  }
}
```

---

## 3. 보안 및 기타 처리

- Cafe24에서 오는 요청은 **Webhook Signature 검증** 필요
- 주문 중복 수신 시 `order_number`로 중복 방지
- 취소/환불 이벤트 발생 시 재계산 로직 추가 가능


---


next.js api routes 로 하는걸로 하고 데이터베이스 스키마 및 설계 명세서를 작성해줘.

1. kol 의 각 소속 전문점은 cafe24 및 본사 주문등록페이지에서 제품을 주문한다.
2. 이 제품들의 목록과 가격은 아래와 같다.
큐어부스터 74800
올인원세럼 77000
V앰플 220,000
퓨어솔루션 418,000
마이크로젯 부스터 149,000

기기의 목록은 가격이 중요하지않고 대수만 중요하다

3. 이 제품들의 가격과 수량을 바탕으로 각 소속 전문점의 매출이 나온다. 제품의 목록에서나오는 매출에서 30% 를 곱한것이 각 kol 의 수당이다. 이건 월별로 관리되어야한다. 각 kol 별 각 전문점별 총합이 필요하다.
4. 각 소속 전문점과 kol 별로 위 제품 (기기가아닌) 이 어느정도 비율로 쓰이는지 각각 관리될수 있어야한다.
5. 이미지와 같이, 전문점별 순위가 월평균매출, 당월 매출, 누적매출로 관리되어야한다. (이 매출은 제품(기기 제외) 기준이다.)
6. 이미지와 같이, 각 전문점별 당월 매출, 당월 수당, 월평균 매출, 누적 수당이 관리되어야한다. (수당은 기기수당도 포함된다) - 즉 이 전문점을 관리하는 kol 이 이 전문점을 통해 받을 수당을 의미한다.
7. 두번쨰 이미지와 같이, 각 전문점별 어느정도 제품을 주문했는지 비율이 관리되어야하고, 월별 매출과 수당이 관리되어야한다.
8. kol 밑에 다른 kol 이 있을수 있는데, 이때 상위 kol 은 하위 kol 의 맨 첫달 (kol 으로 등록된) 매출 총합의 10% 를 수당으로 추가로 얻는다. 즉 shop 에는 kol 인지 아닌지 알수있게끔 관리가 되어야한다.
9. 세번째 이미지처럼, 전월 매출 및 전월 수당이 당월 매출과 당월 수당과 비교될수있게끔 관리되어야한다. 각 kol 의 소속 전문점 중에 당월 매출이 있는지 없는지도 관리되어야한다. 

=

이미지는 예시 ui 일 뿐 나의 요구사항에만 집중할것.