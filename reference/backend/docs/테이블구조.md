create table public.activities (
  id serial not null,
  user_id integer not null,
  activity_type character varying(50) not null,
  lead_id integer null,
  customer_id integer null,
  seminar_id integer null,
  description text null,
  start_time timestamp without time zone not null default now(),
  end_time timestamp without time zone null,
  outcome text null,
  created_at timestamp without time zone not null default now(),
  updated_at timestamp without time zone not null default now(),
  constraint activities_pkey primary key (id),
  constraint activities_unique_user_lead unique (user_id, lead_id, activity_type),
  constraint activities_customer_id_customers_id_fk foreign KEY (customer_id) references customers (id),
  constraint activities_lead_id_leads_id_fk foreign KEY (lead_id) references leads (id),
  constraint activities_seminar_id_seminars_id_fk foreign KEY (seminar_id) references seminars (id),
  constraint activities_user_id_users_id_fk foreign KEY (user_id) references users (id)
) TABLESPACE pg_default;


create table public.commissions (
  id serial not null,
  sale_id integer not null,
  recipient_type character varying(20) not null,
  recipient_id integer not null,
  amount numeric(10, 2) not null,
  status character varying(20) not null default 'pending'::character varying,
  payment_date timestamp without time zone null,
  created_at timestamp without time zone not null default now(),
  updated_at timestamp without time zone not null default now(),
  is_device_sale boolean null default false,
  device_sale_number integer null,
  commission_tier character varying(20) null,
  constraint commissions_pkey primary key (id),
  constraint commissions_sale_id_sales_id_fk foreign KEY (sale_id) references sales (id)
) TABLESPACE pg_default;

create index IF not exists idx_commissions_is_device_sale on public.commissions using btree (is_device_sale) TABLESPACE pg_default;


create table public.customers (
  id serial not null,
  lead_id integer null,
  name text not null,
  email character varying(256) null,
  phone character varying(50) null,
  address text null,
  birth_date timestamp without time zone null,
  gender character varying(10) null,
  shop_id integer null,
  assigned_to integer null,
  created_at timestamp without time zone not null default now(),
  updated_at timestamp without time zone not null default now(),
  constraint customers_pkey primary key (id),
  constraint customers_assigned_to_users_id_fk foreign KEY (assigned_to) references users (id),
  constraint customers_lead_id_leads_id_fk foreign KEY (lead_id) references leads (id),
  constraint customers_shop_id_shops_id_fk foreign KEY (shop_id) references shops (id)
) TABLESPACE pg_default;


create table public.kols (
  id serial not null,
  user_id integer not null,
  specialty text null,
  bio text null,
  contract_start_date timestamp without time zone null,
  contract_end_date timestamp without time zone null,
  commission_rate numeric(5, 2) null,
  status character varying(20) not null default 'active'::character varying,
  bank_account text null,
  created_at timestamp without time zone not null default now(),
  updated_at timestamp without time zone not null default now(),
  affiliated_shop_id integer null,
  device_sales_count integer null default 0,
  is_shop boolean null default false,
  parent_kol_id integer null,
  constraint kols_pkey primary key (id),
  constraint kols_affiliated_shop_id_fkey foreign KEY (affiliated_shop_id) references shops (id),
  constraint kols_parent_kol_id_fkey foreign KEY (parent_kol_id) references kols (id),
  constraint kols_user_id_users_id_fk foreign KEY (user_id) references users (id)
) TABLESPACE pg_default;

create index IF not exists idx_kols_affiliated_shop_id on public.kols using btree (affiliated_shop_id) TABLESPACE pg_default;

create index IF not exists idx_kols_parent_kol_id on public.kols using btree (parent_kol_id) TABLESPACE pg_default;

create table public.lead_sources (
  id serial not null,
  name character varying(100) not null,
  description text null,
  created_at timestamp without time zone not null default now(),
  updated_at timestamp without time zone not null default now(),
  constraint lead_sources_pkey primary key (id)
) TABLESPACE pg_default;

create table public.lead_statuses (
  id serial not null,
  name character varying(100) not null,
  description text null,
  "order" integer not null,
  color character varying(50) null,
  created_at timestamp without time zone not null default now(),
  updated_at timestamp without time zone not null default now(),
  constraint lead_statuses_pkey primary key (id)
) TABLESPACE pg_default;


create table public.leads (
  id serial not null,
  name text not null,
  email character varying(256) null,
  phone character varying(50) null,
  status_id integer null,
  source_id integer null,
  assigned_to integer null,
  notes text null,
  created_at timestamp without time zone not null default now(),
  updated_at timestamp without time zone not null default now(),
  seminar_reservation_date timestamp with time zone null,
  cafe_id character varying(100) null,
  constraint leads_pkey primary key (id),
  constraint leads_email_unique unique (email),
  constraint leads_assigned_to_users_id_fk foreign KEY (assigned_to) references users (id),
  constraint leads_source_id_lead_sources_id_fk foreign KEY (source_id) references lead_sources (id),
  constraint leads_status_id_lead_statuses_id_fk foreign KEY (status_id) references lead_statuses (id)
) TABLESPACE pg_default;

create index IF not exists idx_leads_seminar_reservation_date on public.leads using btree (seminar_reservation_date) TABLESPACE pg_default;


create table public.notifications (
  id serial not null,
  user_id integer not null,
  title text not null,
  content text null,
  type character varying(50) not null,
  lead_id integer null,
  customer_id integer null,
  seminar_id integer null,
  task_id integer null,
  is_read boolean not null default false,
  created_at timestamp without time zone not null default now(),
  constraint notifications_pkey primary key (id),
  constraint notifications_customer_id_customers_id_fk foreign KEY (customer_id) references customers (id),
  constraint notifications_lead_id_leads_id_fk foreign KEY (lead_id) references leads (id),
  constraint notifications_seminar_id_seminars_id_fk foreign KEY (seminar_id) references seminars (id),
  constraint notifications_task_id_tasks_id_fk foreign KEY (task_id) references tasks (id),
  constraint notifications_user_id_users_id_fk foreign KEY (user_id) references users (id)
) TABLESPACE pg_default;

create table public.permissions (
  id serial not null,
  name character varying(100) not null,
  description text null,
  resource character varying(50) not null,
  action character varying(50) not null,
  created_at timestamp without time zone not null default now(),
  updated_at timestamp without time zone not null default now(),
  constraint permissions_pkey primary key (id),
  constraint permissions_name_unique unique (name)
) TABLESPACE pg_default;


create table public.product_categories (
  id serial not null,
  name character varying(100) not null,
  code character varying(50) null,
  parent_id integer null,
  description text null,
  created_at timestamp without time zone not null default now(),
  updated_at timestamp without time zone not null default now(),
  constraint product_categories_pkey primary key (id),
  constraint product_categories_parent_fk foreign KEY (parent_id) references product_categories (id)
) TABLESPACE pg_default;


create table public.products (
  id serial not null,
  name text not null,
  code character varying(100) not null,
  category_id integer null,
  description text null,
  price numeric(10, 2) null,
  commission_rate numeric(5, 2) null,
  created_at timestamp without time zone not null default now(),
  updated_at timestamp without time zone not null default now(),
  constraint products_pkey primary key (id),
  constraint products_category_id_product_categories_id_fk foreign KEY (category_id) references product_categories (id)
) TABLESPACE pg_default;

create table public.regions (
  id serial not null,
  name character varying(100) not null,
  code character varying(50) null,
  parent_id integer null,
  level integer not null,
  created_at timestamp without time zone not null default now(),
  updated_at timestamp without time zone not null default now(),
  constraint regions_pkey primary key (id),
  constraint regions_parent_fk foreign KEY (parent_id) references regions (id)
) TABLESPACE pg_default;

create table public.role_permissions (
  id serial not null,
  role_id integer not null,
  permission_id integer not null,
  created_at timestamp without time zone not null default now(),
  constraint role_permissions_pkey primary key (id),
  constraint role_permissions_permission_id_permissions_id_fk foreign KEY (permission_id) references permissions (id) on delete CASCADE,
  constraint role_permissions_role_id_roles_id_fk foreign KEY (role_id) references roles (id) on delete CASCADE
) TABLESPACE pg_default;

create table public.roles (
  id serial not null,
  name character varying(50) not null,
  description text null,
  created_at timestamp without time zone not null default now(),
  updated_at timestamp without time zone not null default now(),
  constraint roles_pkey primary key (id),
  constraint roles_name_unique unique (name)
) TABLESPACE pg_default;

create table public.sales (
  id serial not null,
  product_id integer not null,
  customer_id integer not null,
  shop_id integer null,
  sales_rep_id integer null,
  kol_id integer null,
  quantity integer not null default 1,
  price numeric(10, 2) not null,
  sale_date timestamp without time zone not null default now(),
  created_at timestamp without time zone not null default now(),
  updated_at timestamp without time zone not null default now(),
  constraint sales_pkey primary key (id),
  constraint sales_customer_id_customers_id_fk foreign KEY (customer_id) references customers (id),
  constraint sales_kol_id_kols_id_fk foreign KEY (kol_id) references kols (id),
  constraint sales_product_id_products_id_fk foreign KEY (product_id) references products (id),
  constraint sales_sales_rep_id_users_id_fk foreign KEY (sales_rep_id) references users (id),
  constraint sales_shop_id_shops_id_fk foreign KEY (shop_id) references shops (id)
) TABLESPACE pg_default;


create table public.sales_activities (
  id serial not null,
  user_id integer not null,
  activity_type character varying(50) not null,
  shop_id integer null,
  lead_id integer null,
  customer_id integer null,
  description text null,
  result text null,
  activity_date timestamp without time zone not null default now(),
  created_at timestamp without time zone not null default now(),
  updated_at timestamp without time zone not null default now(),
  constraint sales_activities_pkey primary key (id),
  constraint sales_activities_customer_id_customers_id_fk foreign KEY (customer_id) references customers (id),
  constraint sales_activities_lead_id_leads_id_fk foreign KEY (lead_id) references leads (id),
  constraint sales_activities_shop_id_shops_id_fk foreign KEY (shop_id) references shops (id),
  constraint sales_activities_user_id_users_id_fk foreign KEY (user_id) references users (id)
) TABLESPACE pg_default;


create table public.seminar_attendees (
  id serial not null,
  seminar_id integer not null,
  lead_id integer not null,
  attendance_status character varying(50) not null default 'registered'::character varying,
  feedback text null,
  created_at timestamp without time zone not null default now(),
  updated_at timestamp without time zone not null default now(),
  constraint seminar_attendees_pkey primary key (id),
  constraint seminar_attendees_unique unique (seminar_id, lead_id),
  constraint seminar_attendees_lead_id_leads_id_fk foreign KEY (lead_id) references leads (id),
  constraint seminar_attendees_seminar_id_seminars_id_fk foreign KEY (seminar_id) references seminars (id)
) TABLESPACE pg_default;


create table public.settings (
  id serial not null,
  category character varying(50) not null,
  key character varying(100) not null,
  value text not null,
  description text null,
  created_at timestamp without time zone not null default now(),
  updated_at timestamp without time zone not null default now(),
  constraint settings_pkey primary key (id)
) TABLESPACE pg_default;


create table public.shops (
  id serial not null,
  name text not null,
  owner_name text null,
  address text null,
  phone character varying(50) null,
  email character varying(256) null,
  business_number character varying(100) null,
  status character varying(50) not null default 'active'::character varying,
  manager_id integer null,
  region_id integer null,
  created_at timestamp without time zone not null default now(),
  updated_at timestamp without time zone not null default now(),
  converted_from_lead_id integer null,
  kol_id integer null,
  constraint shops_pkey primary key (id),
  constraint shops_converted_from_lead_id_fkey foreign KEY (converted_from_lead_id) references leads (id) on delete set null,
  constraint shops_kol_id_fkey foreign KEY (kol_id) references kols (id) on delete set null,
  constraint shops_manager_id_users_id_fk foreign KEY (manager_id) references users (id),
  constraint shops_region_id_regions_id_fk foreign KEY (region_id) references regions (id)
) TABLESPACE pg_default;

create index IF not exists idx_shops_converted_from_lead_id on public.shops using btree (converted_from_lead_id) TABLESPACE pg_default;

create index IF not exists idx_shops_kol_id on public.shops using btree (kol_id) TABLESPACE pg_default;


create table public.tasks (
  id serial not null,
  title text not null,
  description text null,
  assigned_to integer not null,
  assigned_by integer null,
  due_date timestamp without time zone null,
  priority character varying(20) not null default 'medium'::character varying,
  status character varying(20) not null default 'pending'::character varying,
  lead_id integer null,
  customer_id integer null,
  seminar_id integer null,
  created_at timestamp without time zone not null default now(),
  updated_at timestamp without time zone not null default now(),
  constraint tasks_pkey primary key (id),
  constraint tasks_unique_combination unique (title, assigned_to, lead_id),
  constraint tasks_customer_id_customers_id_fk foreign KEY (customer_id) references customers (id),
  constraint tasks_assigned_by_users_id_fk foreign KEY (assigned_by) references users (id),
  constraint tasks_seminar_id_seminars_id_fk foreign KEY (seminar_id) references seminars (id),
  constraint tasks_lead_id_leads_id_fk foreign KEY (lead_id) references leads (id),
  constraint tasks_assigned_to_users_id_fk foreign KEY (assigned_to) references users (id)
) TABLESPACE pg_default;


create table public.user_roles (
  id serial not null,
  user_id integer not null,
  role_id integer not null,
  created_at timestamp without time zone not null default now(),
  constraint user_roles_pkey primary key (id),
  constraint user_roles_unique unique (user_id, role_id),
  constraint user_roles_role_id_roles_id_fk foreign KEY (role_id) references roles (id) on delete CASCADE,
  constraint user_roles_user_id_users_id_fk foreign KEY (user_id) references users (id) on delete CASCADE
) TABLESPACE pg_default;


create table public.users (
  id serial not null,
  email character varying(256) not null,
  password_hash character varying(256) not null,
  full_name text not null,
  role character varying(50) not null,
  profile_image text null,
  phone character varying(50) null,
  created_at timestamp without time zone not null default now(),
  updated_at timestamp without time zone not null default now(),
  constraint users_pkey primary key (id),
  constraint users_email_unique unique (email)
) TABLESPACE pg_default;


create table public.seminars (
  id serial not null,
  title text not null,
  description text null,
  location text null,
  start_date timestamp without time zone not null,
  end_date timestamp without time zone null,
  organizer_id integer null,
  max_attendees integer null,
  status character varying(50) not null default 'scheduled'::character varying,
  created_at timestamp without time zone not null default now(),
  updated_at timestamp without time zone not null default now(),
  constraint seminars_pkey primary key (id),
  constraint seminars_title_unique unique (title),
  constraint seminars_organizer_id_users_id_fk foreign KEY (organizer_id) references users (id)
) TABLESPACE pg_default;

create table public.seminar_attendees (
  id serial not null,
  seminar_id integer not null,
  lead_id integer not null,
  attendance_status character varying(50) not null default 'registered'::character varying,
  feedback text null,
  created_at timestamp without time zone not null default now(),
  updated_at timestamp without time zone not null default now(),
  constraint seminar_attendees_pkey primary key (id),
  constraint seminar_attendees_unique unique (seminar_id, lead_id),
  constraint seminar_attendees_lead_id_leads_id_fk foreign KEY (lead_id) references leads (id),
  constraint seminar_attendees_seminar_id_seminars_id_fk foreign KEY (seminar_id) references seminars (id)
) TABLESPACE pg_default;