## 📖 BIOFOX 사용 시나리오 명세서

### 1. 시나리오 분류 체계

#### 1.1 주요 액터별 시나리오
- **관리자 시나리오**: 데이터 입력, 승인, 시스템 관리
- **KOL/OL 시나리오**: CRM 관리, 임상 조회, 수수료 확인
- **Shop Owner 시나리오**: 셀프성장, 임상 등록, 교육 수강

#### 1.2 기능별 시나리오
- **사용자 관리**: 회원가입, 승인, 권한 관리
- **CRM 관리**: 카드 생성, 단계 관리, 데이터 연동
- **임상 관리**: 케이스 등록, 사진 업로드, 진행 추적
- **매출 관리**: 데이터 입력, 수수료 계산, 정산

---

### 2. 사용자 관리 시나리오

#### 2.1 시나리오: 새 사용자 회원가입 및 승인
**액터**: 신규 사용자, 관리자  
**목표**: 새로운 전문점 원장이 시스템에 가입하여 승인받기

**메인 플로우**:
```
1. [신규 사용자] 회원가입 페이지 접속
2. [신규 사용자] 기본 정보 입력
   - 이메일, 비밀번호, 이름, 샵명
   - 지역, 네이버 플레이스 링크 (선택)
   - 역할 선택 (kol, ol, shop_owner)
3. [시스템] 계정 생성, 상태를 'pending'으로 설정
4. [시스템] 관리자에게 승인 요청 알림 발송
5. [관리자] 승인 대기 목록에서 신규 가입자 확인
6. [관리자] 가입자 정보 검토 및 승인/거절 결정
7. [관리자] 승인 처리 (상태를 'approved'로 변경)
8. [시스템] 가입자에게 승인 완료 알림 발송
9. [신규 사용자] 로그인하여 시스템 이용 시작
```

**대안 플로우**:
```
6a. [관리자] 승인 거절하는 경우
    - 거절 사유 입력
    - 상태를 'rejected'로 변경
    - 가입자에게 거절 알림 발송
```

**예외 플로우**:
```
- 중복 이메일로 가입 시도: 에러 메시지 표시
- 필수 정보 미입력: 유효성 검사 실패
- 네트워크 오류: 재시도 안내
```

#### 2.2 시나리오: 소속 관계 설정
**액터**: 관리자, KOL, Shop Owner  
**목표**: 새로 가입한 Shop Owner를 특정 KOL 소속으로 설정

**메인 플로우**:
```
1. [관리자] 소속 관계 관리 페이지 접속
2. [관리자] 새로 가입한 Shop Owner 선택
3. [관리자] 소속시킬 KOL/OL 선택
4. [관리자] 소속 시작일 설정 (기본: 오늘)
5. [시스템] Shop_Relationship 레코드 생성
   - shop_owner_id: 선택한 Shop Owner
   - parent_id: 선택한 KOL/OL
   - is_active: true
6. [시스템] KOL과 Shop Owner에게 소속 설정 알림 발송
```

**대안 플로우**:
```
3a. [관리자] 기존 소속 관계 변경하는 경우
    - 기존 관계의 ended_at 설정, is_active를 false로 변경
    - 새 관계 레코드 생성
```

---

### 3. CRM 관리 시나리오

#### 3.1 시나리오: KOL이 새 CRM 카드 생성
**액터**: KOL, 시스템  
**목표**: 새로운 소속 전문점을 위한 CRM 카드 생성

**메인 플로우**:
```
1. [KOL] CRM 관리 페이지 접속
2. [KOL] "새 카드 추가" 버튼 클릭
3. [시스템] 소속 전문점 목록 표시 (CRM 카드가 없는 전문점만)
4. [KOL] 관리할 전문점 선택
5. [KOL] 기본 정보 입력
   - 담당자명 (전문점 원장 이름)
   - 샵명 확인
   - 초기 메모 (선택)
6. [시스템] CRM_Card 레코드 생성
   - kol_id: 현재 KOL
   - shop_id: 선택한 전문점
   - 모든 단계 상태: false
7. [시스템] 해당 전문점의 Self_Growth_Card 자동 생성
   - shop_id: 선택한 전문점
   - crm_card_id: 방금 생성한 CRM 카드
8. [시스템] 해당 전문점 원장에게 CRM 카드 생성 알림 발송
9. [KOL] 생성된 CRM 카드 확인 및 첫 단계 진행 시작
```

**예외 플로우**:
```
- 이미 CRM 카드가 있는 전문점 선택: 에러 메시지
- 소속 전문점이 없는 경우: 안내 메시지
```

#### 3.2 시나리오: CRM 단계별 진행 관리
**액터**: KOL  
**목표**: 특정 전문점의 CRM 단계를 진행하며 관리

**메인 플로우**:
```
1. [KOL] CRM 카드 목록에서 관리할 전문점 선택
2. [KOL] CRM 카드 상세 페이지 진입
3. [KOL] 현재 진행 중인 단계 확인
4. [KOL] 다음 단계 진행 또는 현재 단계 완료 처리
   
   예시: 3단계 (교육) 진행
   - 설치교육 정보 입력
     * 설치교육 날짜
     * 담당자명
     * 연락처
   - 교육 완료 체크
   - 다음 단계 안내사항 확인

5. [시스템] CRM_Card 업데이트
   - stage_3_status: true
   - installation_date, installation_manager, installation_contact 저장
6. [시스템] 연동되는 Self_Growth_Card 자동 업데이트
   - 설치교육 정보 동기화
7. [시스템] 해당 전문점에 진행 상황 알림 발송
8. [KOL] 특이사항 및 메모 추가 입력 (선택)
```

**대안 플로우**:
```
4a. [KOL] 순서와 관계없이 다른 단계 진행
    - 어떤 단계든 자유롭게 체크 가능
    - 이미 완료된 단계도 재수정 가능
```

#### 3.3 시나리오: 특이사항 질문 관리 및 연동
**액터**: KOL, Shop Owner  
**목표**: 자가평가와 KOL 평가 간 데이터 연동

**메인 플로우**:
```
1. [Shop Owner] 셀프성장 카드에서 자가평가 실시
   - Q1: 클레오비스는 세탁하였는가? → Y 선택
   - Q2: 인스타슈어 세탁하였는가? → Y 선택
   - Q3: 정품 및 정량 프로토콜로 시행하고 있는가? → N 선택
   - Q4: 상품 진행이 잘 되어가는가? → Y 선택

2. [시스템] Self_Growth_Card 업데이트
3. [시스템] 연동되는 CRM_Card 자동 업데이트
   - q1_cleobios: 'Y'
   - q2_instasure: 'Y'
   - q3_proper_procedure: 'N'
   - q4_progress_check: 'Y'

4. [시스템] KOL에게 자가평가 완료 알림 발송
5. [KOL] CRM 카드에서 자동 연동된 답변 확인
6. [KOL] 5번, 6번 질문 추가 평가 (KOL 전용)
   - Q5: 상담을 잘 이루어내는가? → '상' 선택
   - Q6: 샵을 잘관리하고 있는가? → '중' 선택
7. [KOL] 종합 평가 메모 작성
```

---

### 4. 임상 관리 시나리오

#### 4.1 시나리오: 새 임상 케이스 등록
**액터**: Shop Owner  
**목표**: 새로운 고객의 임상 케이스를 시작

**메인 플로우**:
```
1. [Shop Owner] 임상 관리 페이지 접속
2. [Shop Owner] "새 고객 임상" 버튼 클릭
3. [Shop Owner] 고객 기본 정보 입력
   - 고객명: "김고객"
   - 성별: 여성
   - 나이: 35세
   - 관리품목: "관리 후희"
4. [Shop Owner] 활용 동의 여부 선택
   - 동의함 선택
5. [시스템] Clinical_Case 레코드 생성
   - shop_id: 현재 Shop Owner
   - subject_type: 'customer'
   - status: 'in_progress'
   - consent_status: 'consented'
6. [시스템] 동의서 업로드 요청 알림
7. [Shop Owner] 동의서 파일 업로드 (PDF)
8. [시스템] Consent_File 레코드 생성
9. [Shop Owner] Before 사진 업로드
   - 정면, 좌측면, 우측면 각 1장씩
10. [시스템] Clinical_Photo 레코드 3개 생성
    - session_number: 0 (Before)
    - photo_type: 'front', 'left_side', 'right_side'
```

**대안 플로우**:
```
4a. [Shop Owner] 활용 동의하지 않음 선택
    - consent_status: 'no_consent'
    - 동의서 업로드 불필요
    - 임상 데이터는 관리자가 별도 조회 불가
```

#### 4.2 시나리오: 임상 회차 진행 및 사진 업로드
**액터**: Shop Owner  
**목표**: 1회차 시술 후 경과 사진 업로드

**메인 플로우**:
```
1. [Shop Owner] 진행 중인 임상 케이스 선택
2. [Shop Owner] "새 회차 추가" 버튼 클릭
3. [Shop Owner] 회차 정보 입력
   - 회차: 1회차
   - 시술일: 2025-01-15
   - 사용 제품: "관리 후희"
   - 시술 내용 메모
4. [Shop Owner] 1회차 사진 업로드
   - 정면, 좌측면, 우측면 각 1장씩
   - 각 파일 크기 < 10MB 확인
5. [시스템] Clinical_Photo 레코드 3개 생성
   - session_number: 1
   - photo_type: 'front', 'left_side', 'right_side'
6. [시스템] Clinical_Case의 total_sessions 업데이트
7. [시스템] 소속 KOL에게 진행 상황 알림 발송
```

**예외 플로우**:
```
- 파일 크기 초과: 에러 메시지 및 리사이즈 안내
- 지원하지 않는 파일 형식: 허용 형식 안내
- 네트워크 업로드 실패: 재시도 옵션 제공
```

#### 4.3 시나리오: KOL이 소속 전문점 임상 현황 조회
**액터**: KOL  
**목표**: 소속 전문점들의 임상 진행 현황 파악

**메인 플로우**:
```
1. [KOL] 임상 현황 대시보드 접속
2. [시스템] 소속 전문점별 임상 통계 표시
   - A 전문점: 본인 임상 5회차, 고객 임상 3명 진행중
   - B 전문점: 본인 임상 10회차 완료, 고객 임상 7명 진행중
   - C 전문점: 본인 임상 3회차, 고객 임상 1명 진행중
3. [KOL] 특정 전문점 선택하여 상세 조회
4. [시스템] 선택한 전문점의 모든 임상 케이스 목록 표시
5. [KOL] 개별 임상 케이스 클릭하여 상세 정보 조회
   - 고객 정보 (동의한 경우만)
   - 회차별 진행 상황
   - Before/After 사진 (동의한 경우만)
6. [KOL] CRM 카드에서 임상 현황 연동 확인
   - "보러가기" 버튼으로 임상 시스템 이동
```

**권한 제약**:
```
- 미동의 고객 임상: 통계만 조회, 개인정보 비공개
- 동의 고객 임상: 모든 정보 조회 가능
- 타 KOL 소속 전문점: 조회 불가
```

---

### 5. 매출 및 수수료 관리 시나리오

#### 5.1 시나리오: 관리자가 월별 매출 데이터 입력
**액터**: 관리자  
**목표**: 각 전문점의 월별 매출 데이터 입력 및 수수료 계산

**메인 플로우**:
```
1. [관리자] 매출 관리 페이지 접속
2. [관리자] 매출 입력 대상 월 선택 (예: 2025년 1월)
3. [관리자] 전문점별 매출 데이터 입력
   
   예시: A 전문점 (김원장님)
   - 주문일: 2025-01-15
   - 총 매출: 2,500,000원
   - 비고: 정상 매출
   
4. [시스템] Order 레코드 생성
   - shop_id: A 전문점 ID
   - total_amount: 2,500,000
   - order_date: 2025-01-15
   - created_by: 관리자 ID

5. [시스템] 소속 관계 확인
   - A 전문점 → B KOL 소속 확인
   - B KOL의 역할: 'kol' (30% 수수료)

6. [시스템] 자동 수수료 계산
   - 기본 수수료: 2,500,000 × 0.30 = 750,000원
   - commission_rate: 30.00
   - commission_amount: 750,000

7. [시스템] Order 레코드 업데이트
8. [시스템] B KOL에게 매출 발생 알림 발송
```

**대안 플로우**:
```
3a. [관리자] 반품 데이터 입력하는 경우
    - 총 매출: -500,000원 (음수)
    - 수수료도 자동으로 음수 계산
```

#### 5.2 시나리오: 기기 판매 및 누적 대수 관리
**액터**: 관리자  
**목표**: 마이크로젯 기기 판매 입력 및 KOL 누적 대수 업데이트

**메인 플로우**:
```
1. [관리자] 기기 판매 관리 페이지 접속
2. [관리자] 기기 판매 정보 입력
   - 구매 전문점: C 전문점 (이원장님)
   - 판매일: 2025-01-20
   - 수량: 1대
   - 비고: 신규 구매

3. [시스템] C 전문점의 소속 KOL 확인
   - C 전문점 → D KOL 소속

4. [시스템] D KOL의 현재 누적 대수 조회
   - 기존 누적: 4대 (tier_1_4)

5. [시스템] Device_Sale 레코드 생성
   - shop_id: C 전문점
   - quantity: 1
   - standard_commission: 1,500,000 (현재 티어 기준)
   - actual_commission: 1,500,000

6. [시스템] KOL 누적 대수 업데이트
   - 새 누적: 5대 → tier_5_plus로 변경
   - 다음 판매부터 250만원 적용

7. [시스템] D KOL에게 기기 판매 및 티어 업그레이드 알림
```

**대안 플로우**:
```
2a. [관리자] 기기 반품 처리하는 경우
    - 수량: -1대
    - 누적 대수에서 차감
    - 필요시 티어 다운그레이드
```

#### 5.3 시나리오: 월별 수수료 정산 및 조정
**액터**: 관리자  
**목표**: 월말 수수료 정산 및 필요시 수동 조정

**메인 플로우**:
```
1. [관리자] 수수료 정산 페이지 접속
2. [관리자] 정산 대상 월 선택 (예: 2025년 1월)
3. [시스템] 월별 자동 계산 실행
   
   예시: B KOL 1월 수수료
   - 소속 전문점 매출 수수료: 2,250,000원
   - 기기 판매 수수료: 1,500,000원
   - 본인샵 매출 수수료: 450,000원 (별도 계산)
   - 총 수수료: 4,200,000원

4. [시스템] Commission_Calculation 레코드 생성
5. [관리자] 자동 계산 결과 검토
6. [관리자] 필요시 수동 조정
   - 특별 보너스: +300,000원
   - 조정 사유: "신규 KOL 인센티브"
   - 최종 수수료: 4,500,000원
7. [시스템] 조정 내역 audit_log에 기록
8. [관리자] 수수료 지급 처리
   - status: 'calculated' → 'paid'
   - payment_date: 2025-02-01
9. [시스템] B KOL에게 수수료 지급 완료 알림
```

---

### 6. 통합 시나리오

#### 6.1 시나리오: 신규 전문점의 전체 온보딩 프로세스
**액터**: 신규 Shop Owner, KOL, 관리자  
**목표**: 신규 전문점이 가입부터 임상 시작까지 완전한 온보딩

**통합 플로우**:
```
Week 1: 가입 및 승인
1. [신규 원장] 회원가입 (role: shop_owner)
2. [관리자] 신규 가입 승인
3. [관리자] 특정 KOL 소속으로 배정

Week 2: CRM 시작
4. [KOL] 신규 전문점용 CRM 카드 생성
5. [시스템] 셀프성장 카드 자동 생성
6. [KOL] 1단계(유입) → 2단계(계약) 진행
7. [KOL] 설치교육 일정 수립 및 정보 입력

Week 3: 교육 및 설정
8. [시스템] 설치교육 정보 셀프성장 카드에 연동
9. [신규 원장] 본사실무교육 신청
10. [KOL] 3단계(교육) 완료 처리
11. [신규 원장] 자가평가 실시
12. [시스템] 자가평가 결과 CRM 카드에 연동

Week 4: 임상 시작
13. [신규 원장] 본인 임상 케이스 등록
14. [신규 원장] Before 사진 업로드
15. [KOL] 4단계(임상) 시작으로 업데이트
16. [관리자] 첫 달 매출 데이터 입력
17. [시스템] 수수료 자동 계산
18. [KOL] CRM에서 임상 진행 현황 확인
```

#### 6.2 시나리오: 월말 종합 정산 프로세스
**액터**: 관리자, 모든 KOL/OL  
**목표**: 월말 전체 데이터 정산 및 리포트 생성

**통합 플로우**:
```
월말 D-3일:
1. [관리자] 모든 전문점 매출 데이터 입력 완료
2. [관리자] 기기 판매 데이터 입력 완료
3. [시스템] 데이터 무결성 검증

월말 D-1일:
4. [시스템] 월별 자동 집계 실행
   - 각 KOL별 소속 전문점 수 계산
   - 활성 전문점 수 계산
   - 매출 합계 계산
   - 수수료 계산
5. [관리자] 계산 결과 검토 및 조정

월말 당일:
6. [관리자] 최종 수수료 확정
7. [시스템] Monthly_Report 생성
8. [시스템] 모든 KOL/OL에게 월별 리포트 발송

차월 1일:
9. [관리자] 수수료 지급 처리
10. [시스템] 지급 완료 알림 발송
```

---

## 🎯 시나리오 구현 우선순위

### Phase 1 (핵심 기능)
1. ✅ 사용자 가입 및 승인
2. ✅ 소속 관계 설정
3. ✅ 기본 CRM 카드 생성 및 관리
4. ✅ 매출 데이터 입력 및 수수료 계산

### Phase 2 (고급 기능)
1. ✅ CRM-셀프성장 카드 연동
2. ✅ 임상 케이스 기본 관리
3. ✅ 기기 판매 및 누적 관리

### Phase 3 (완성 기능)
1. ✅ 복잡한 임상 사진 관리
2. ✅ 동의서 및 권한 관리
3. ✅ 종합 대시보드 및 리포트